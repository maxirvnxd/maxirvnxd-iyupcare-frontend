<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- API BASE (HF) -->
  <meta name="api-base" content="https://maxirvnxd-iyupcare-backend.hf.space/api" />

  <title>Konsultasi — iYup Care</title>
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    :root{
      --bg:#f6f9ff;
      --card:#ffffff;
      --ink:#0b1b3a;
      --muted:#5b6b80;
      --line: rgba(15,23,42,.10);
      --shadow2: 0 12px 30px rgba(15,23,42,.08);
      --primary:#1e63d6;
      --green:#1f9d55;
      --radius:18px;
      --max:1100px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 15% 10%, rgba(30,99,214,.16), transparent 60%),
        radial-gradient(800px 520px at 90% 0%, rgba(31,157,85,.12), transparent 58%),
        radial-gradient(800px 520px at 90% 90%, rgba(242,153,74,.10), transparent 55%),
        var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }
    a{ color:inherit; text-decoration:none; }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .topbar-inner{
      max-width: var(--max);
      margin: 0 auto;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .brand img{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      object-fit: cover;
      background:#fff;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 20px rgba(15,23,42,.12);
      display:block;
    }
    .brand .b1{ font-weight: 950; letter-spacing:.2px; }
    .brand .b2{ font-size: 12px; color: var(--muted); margin-top:2px; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btnx{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.80);
      font-weight: 950;
      font-size: 13px;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      white-space: nowrap;
      cursor: pointer;
    }
    .btnx:hover{
      border-color: rgba(30,99,214,.25);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
    }
    .btnx.primary{
      background: linear-gradient(180deg, rgba(30,99,214,1), rgba(20,76,175,1));
      border-color: rgba(30,99,214,.0);
      color:#fff;
    }
    .btnx.primary:hover{ filter: brightness(.98); }

    /* Back button (panel header) */
    .btnx.back{
      padding: 9px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,.12);
      color: #111;
      font-weight: 900;
    }

    /* Page wrap */
    .wrap{
      max-width: var(--max);
      margin:0 auto;
      padding: 18px 16px 28px;
    }

    /* Panel container */
    .panel{
      margin-top: 16px;
      border:1px solid rgba(15,23,42,.10);
      border-radius: calc(var(--radius) + 8px);
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panel-head{
      padding: 16px;
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .panel-head .head-row{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      margin-bottom: 10px;
    }
    .panel-head h1{
      margin:0;
      font-size: clamp(20px, 2.6vw, 30px);
      letter-spacing: -.3px;
      line-height: 1.1;
    }
    .panel-head .small{
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.65;
      max-width: 70ch;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      flex-wrap: wrap;
    }
    .tabbtn{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 950;
      font-size: 13px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .tabbtn:hover{
      border-color: rgba(30,99,214,.25);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .tabbtn.active{
      background: rgba(30,99,214,.10);
      border-color: rgba(30,99,214,.25);
      color: var(--ink);
    }

    .tab-panel{
      display:none;
      padding: 16px;
    }
    .tab-panel.active{ display:block; }

    /* Cards */
    .card{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(8px);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card-inner{ padding: 16px; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.72);
    }
    .badge.green{ border-color: rgba(31,157,85,.25); background: rgba(31,157,85,.10); }
    .badge.blue{ border-color: rgba(30,99,214,.25); background: rgba(30,99,214,.10); }

    .muted{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.65;
      margin-top: 8px;
    }

    /* AI Chat UI */
    .chat-shell{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      background: rgba(255,255,255,.70);
      overflow:hidden;
    }
    .chat-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.65);
    }
    .chat-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 950;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(31,157,85,.75);
      box-shadow: 0 0 0 4px rgba(31,157,85,.12);
    }
    .chat-status{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .chat-box{
      height: 430px;
      padding: 14px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .bubble.me{
      align-self:flex-end;
      border-color: rgba(30,99,214,.20);
      background: rgba(30,99,214,.08);
    }
    .bubble.ai{
      align-self:flex-start;
      border-color: rgba(31,157,85,.18);
      background: rgba(31,157,85,.06);
    }
    .bubble.sys{
      align-self:center;
      max-width: 90%;
      text-align:center;
      border-style: dashed;
      color: var(--muted);
      background: rgba(255,255,255,.70);
    }

    .composer{
      display:flex;
      gap:10px;
      padding: 12px;
      border-top: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.65);
      align-items:flex-end;
    }
    .composer textarea{
      width:100%;
      min-height: 44px;
      max-height: 140px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      outline: none;
      font: inherit;
      font-size: 13px;
      background: rgba(255,255,255,.92);
    }
    .composer .send{
      min-width: 104px;
    }

    /* WhatsApp button */
    .btnx.whatsapp{
      background: linear-gradient(180deg, rgba(31,157,85,1), rgba(22,122,66,1));
      border-color: rgba(31,157,85,.0);
      color:#fff;
    }
    .btnx.whatsapp:hover{ filter: brightness(.98); }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }

    /* Single contact layout */
    .grid1{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 2px;
    }

    .foot{
      margin-top: 16px;
      padding: 14px 0 4px;
      border-top: 1px solid rgba(15,23,42,.08);
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    @media (max-width: 980px){
      .brand{ min-width: 0; }
      .chat-box{ height: 380px; }
      .composer .send{ min-width: 92px; }
    }
  </style>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="assets/logo-innoviyup.png" alt="Logo InnoviYup" />
        <div>
          <div class="b1">iYup Care</div>
          <div class="b2">Konsultasi</div>
        </div>
      </div>

      <!-- Hanya 1 tombol: Dashboard (biru) -->
      <div class="actions">
        <a class="btnx primary" href="dashboard.html" id="dashboardBtn">Dashboard</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel" id="tabsRoot">
      <div class="panel-head">
        <!-- Tombol kembali di atas judul -->
        <div class="head-row">
          <a class="btnx back" href="dashboard.html">← Kembali</a>
        </div>

        <h1>Konsultasi</h1>
        <div class="small">
          Gunakan <b>Tanya AI</b> untuk chat cepat, atau <b>Konsultasi Ahli</b> untuk menghubungi tenaga pendamping via WhatsApp.
        </div>
      </div>

      <!-- Tabs: hanya 2 -->
      <div class="tabs">
        <button class="tabbtn active" data-tab="ai" type="button">Tanya AI</button>
        <button class="tabbtn" data-tab="ahli" type="button">Konsultasi Ahli</button>
      </div>

      <!-- TAB AI -->
      <div class="tab-panel active" data-panel="ai">
        <div class="card">
          <div class="card-inner">
            <div class="badge blue">Tanya AI</div>
            <div class="muted" style="margin-top:10px">
              Tulis pertanyaan seputar gizi anak, pola makan, MPASI, atau penggunaan fitur iYup Care.
              Tekan <b>Enter</b> untuk kirim (Shift+Enter untuk baris baru).
            </div>

            <div class="chat-shell" style="margin-top:12px">
              <div class="chat-top">
                <div class="chat-title">
                  <span class="dot"></span>
                  Asisten iYup Care
                </div>
                <div class="chat-status" id="chatStatus">Siap</div>
              </div>

              <div class="chat-box" id="chatBox">
                <div class="bubble ai">Halo! Saya asisten iYup Care. Tanyakan apa saja seputar gizi anak ya.</div>
                <div class="bubble sys">Catatan: AI bukan pengganti dokter. Jika gejala berat/darurat, segera ke fasilitas kesehatan.</div>
              </div>

              <div class="composer">
                <textarea id="chatInput" placeholder="Contoh: Anak 2 tahun susah makan, menu apa yang cocok?"></textarea>
                <button class="btnx primary send" id="sendBtn" type="button">Kirim</button>
              </div>
            </div>

            <div class="hint">
              Tips: Sertakan usia anak, BB/TB (kalau ada), dan keluhan utama agar jawabannya lebih tepat.
            </div>
          </div>
        </div>
      </div>

      <!-- TAB AHLI (hanya 1 kontak) -->
      <div class="tab-panel" data-panel="ahli">
        <div class="grid1">
          <div class="card">
            <div class="card-inner">
              <div class="badge green">Ahli Gizi</div>

              <h3 style="margin:12px 0 0">ALIFLAELA, SGz</h3>
              <div class="muted">
                Nutrisionis Pelaksana di Puskesmas Biromaru. Pendamping edukasi gizi anak (pola makan, MPASI, dan pencegahan stunting) dengan pendekatan praktis yang mudah diterapkan di rumah.
              </div>

              <div style="margin-top:12px">
                <a class="btnx whatsapp" href="https://wa.me/6281340901201" target="_blank" rel="noreferrer">
                  Chat via WA
                </a>
              </div>

              <div class="hint">
                Jika ingin konsultasi lebih tepat, siapkan data: usia anak, BB/TB terbaru, pola makan harian, serta keluhan utama.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="foot">
        © <span id="year"></span> iYup Care
      </div>
    </section>
  </main>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/ui.js"></script>

  <script>
    // tetap pakai auth untuk user web
    requireAuthOrRedirect();
    document.getElementById("year").textContent = new Date().getFullYear();

    // Tabs
    const root = document.getElementById("tabsRoot");
    const tabBtns = root.querySelectorAll(".tabbtn[data-tab]");
    const panels = root.querySelectorAll(".tab-panel[data-panel]");

    function setActiveTab(key){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
      panels.forEach(p => p.classList.toggle("active", p.dataset.panel === key));
    }
    tabBtns.forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));

    // ================== AI CHAT ==================
    // Pastikan ini sesuai worker kamu (yang sudah berhasil di Postman)
    const WORKER_CHAT_URL = "https://iyupcare-ai.maxitabusiness.workers.dev/ai/chat";

    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatStatus = document.getElementById("chatStatus");

    // Simpan history agar model punya konteks (dibatasi biar hemat kuota)
    const history = [
      { role:"assistant", content:"Halo! Saya asisten iYup Care. Tanyakan apa saja seputar gizi anak ya." }
    ];
    const MAX_HISTORY = 18; // hemat kuota

    function addBubble(text, who){
      const div = document.createElement("div");
      div.className = "bubble " + (who === "me" ? "me" : who === "sys" ? "sys" : "ai");
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    function setBusy(busy, label){
      sendBtn.disabled = busy;
      chatInput.disabled = busy;
      chatStatus.textContent = label || (busy ? "Menjawab..." : "Siap");
      sendBtn.textContent = busy ? "Menjawab..." : "Kirim";
    }

    function trimHistory(){
      if(history.length <= MAX_HISTORY) return;
      const keepFirst = history[0];
      const tail = history.slice(-(MAX_HISTORY - 1));
      history.length = 0;
      history.push(keepFirst, ...tail);
    }

    async function askAI(userText){
      history.push({ role:"user", content:userText });
      trimHistory();

      const res = await fetch(WORKER_CHAT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: history })
      });

      const ct = res.headers.get("content-type") || "";
      if(!ct.includes("application/json")){
        const t = await res.text();
        throw new Error("Respon bukan JSON (URL salah / Access aktif / CORS). Potongan: " + t.slice(0,120));
      }

      const data = await res.json();
      if(!res.ok){
        const msg = data?.error || ("HTTP " + res.status);
        const retry = data?.retryAfterSec ? (" (retry " + data.retryAfterSec + "s)") : "";
        throw new Error(msg + retry);
      }

      const reply = String(data?.reply || "").trim();
      if(!reply) throw new Error("Reply kosong dari AI.");

      history.push({ role:"assistant", content: reply });
      trimHistory();
      return reply;
    }

    async function handleSend(){
      const text = (chatInput.value || "").trim();
      if(!text) return;

      addBubble(text, "me");
      chatInput.value = "";

      const loadingBubble = addBubble("…", "ai");
      setBusy(true, "Menjawab...");

      try{
        const reply = await askAI(text);
        loadingBubble.textContent = reply;
      }catch(err){
        loadingBubble.textContent = "Gagal memanggil AI: " + (err?.message || err);
      }finally{
        setBusy(false, "Siap");
        chatBox.scrollTop = chatBox.scrollHeight;
        chatInput.focus();
      }
    }

    sendBtn.addEventListener("click", handleSend);

    // Enter = kirim, Shift+Enter = baris baru
    chatInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });
  </script>
</body>
</html>
