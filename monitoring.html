<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- API BASE (HF) -->
  <meta name="api-base" content="https://maxirvnxd-iyupcare-backend.hf.space/api" />

  <title>Monitoring ‚Äî iYup Care</title>
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    :root{
      --p-bg:#f6f9ff;
      --p-ink:#0b1b3a;
      --p-muted:#5b6b80;
      --p-line: rgba(15,23,42,.10);
      --p-shadow2: 0 12px 30px rgba(15,23,42,.08);
      --p-primary:#1e63d6;
      --p-radius:18px;
      --p-max:1100px;
    }

    body{
      background:
        radial-gradient(900px 520px at 15% 10%, rgba(30,99,214,.16), transparent 60%),
        radial-gradient(800px 520px at 90% 0%, rgba(31,157,85,.12), transparent 58%),
        radial-gradient(800px 520px at 90% 90%, rgba(242,153,74,.10), transparent 55%),
        var(--p-bg);
      color: var(--p-ink);
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .topbar-inner{
      max-width: var(--p-max);
      margin: 0 auto;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .pbrand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .pbrand img{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      object-fit: cover;
      background:#fff;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 20px rgba(15,23,42,.12);
      display:block;
    }
    .pbrand .b1{ font-weight: 950; letter-spacing:.2px; }
    .pbrand .b2{ font-size: 12px; color: var(--p-muted); margin-top:2px; }

    .pactions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .pbtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.80);
      font-weight: 950;
      font-size: 13px;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      white-space: nowrap;
      text-decoration:none;
      color:inherit;
    }
    .pbtn:hover{
      border-color: rgba(30,99,214,.25);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
    }
    .pbtn.primary{
      background: linear-gradient(180deg, rgba(30,99,214,1), rgba(20,76,175,1));
      border-color: rgba(30,99,214,.0);
      color:#fff;
    }
    .pbtn.primary:hover{ filter: brightness(.98); }

    .back-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 12px 0 8px;
      flex-wrap:wrap;
    }

    textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:12px;
      outline:none;
      resize:vertical;
      background:#fff;
    }

    .header-tools{
      margin-top:12px;display:flex;gap:12px;align-items:stretch;flex-wrap:wrap;
    }
    .child-card{
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding:12px 14px;
      flex:1;
      min-width:280px;
      flex-wrap:wrap; /* supaya 3 tombol tetap rapi di layar kecil */
    }
    .child-card .field{flex:1;min-width:220px;}
    .child-card label{display:block;}
    .child-card select{width:100%;}

    .right-tools{display:flex;align-items:flex-end;}

    .modal-backdrop{
      position:fixed; inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:9999;
    }
    .modal{
      width:min(560px, 100%);background:#fff;border-radius:16px;padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.18);
    }
    .modal h3{margin:0 0 10px;}
    .hr{height:1px;background:rgba(0,0,0,.08);margin:12px 0;}

    .btn[disabled]{opacity:.7;cursor:not-allowed;}
    .spinner{
      width:16px;height:16px;border:2px solid rgba(255,255,255,.5);
      border-top-color:#fff;border-radius:50%;display:inline-block;
      animation:spin .75s linear infinite;vertical-align:middle;margin-left:8px;
    }
    @keyframes spin{to{transform:rotate(360deg);} }

    .input-actions{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin: 8px 0 10px;
    }
    .hidden{display:none !important;}
    .dbwrap{margin-top:14px;overflow:auto;}
    .small-muted{opacity:.85;}

    .tab-panel{display:none;}
    .tab-panel.active{display:block;}

    @media (max-width: 980px){
      .topbar-inner{ gap: 10px; }
      .pbrand{ min-width: 0; }
    }

    .galeri-item{ padding:12px; }
    .galeri-item img{
      width:100%;
      height:240px;
      object-fit:cover;
      border-radius:14px;
      display:block;
      background: rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.08);
    }
    .galeri-meta{
      margin-top:8px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .galeri-caption{
      font-weight:700;
      font-size:12px;
      line-height:1.2;
    }
    .galeri-date{
      font-size:12px;
      opacity:.85;
      white-space:nowrap;
    }

    /* =========================================================
       PDF SHEETS (A4 RATIO) ‚Äî supaya tidak distorsi
       A4 ratio ‚âà 0.707. Pakai 794√ó1123 px (mendekati A4 @96dpi)
    ========================================================== */
    .pdf-sheet{
      position:absolute;
      left:-99999px;
      top:0;
      width:794px;
      height:1123px;
      padding:26px;
      box-sizing:border-box;
      background:#ffffff;
    }
    .pdf-card{
      height:100%;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      padding:18px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .pdf-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .pdf-brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }
    .pdf-logo{
      width:44px;height:44px;border-radius:14px;object-fit:cover;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      display:block;
    }
    .pdf-title{
      font-size:22px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.1;
      margin:0;
    }
    .pdf-sub{
      font-size:12px;
      color: var(--p-muted);
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }
    .pdf-meta-right{
      text-align:right;
      font-size:11px;
      color: var(--p-muted);
      white-space:nowrap;
    }

    .pdf-chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:2px;
    }
    .pdf-chip{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(246,249,255,.75);
      padding:7px 10px;
      border-radius:14px;
      font-size:11px;
      line-height:1.2;
    }
    .pdf-chip span{ display:block; color: var(--p-muted); font-size:10px; }
    .pdf-chip b{ display:block; font-weight:900; color: var(--p-ink); margin-top:2px; }

    .pdf-summary{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:10px;
    }
    .sum{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:10px 12px;
      background:#fff;
    }
    .sum .k{ font-size:10px; color: var(--p-muted); }
    .sum .v{ font-size:18px; font-weight:950; margin-top:2px; }
    .sum .s{ font-size:11px; color: var(--p-muted); margin-top:2px; }

    .pdf-section-title{
      font-size:12px;
      font-weight:900;
      color: var(--p-ink);
      margin: 2px 0 -2px;
    }

    /* tabel khusus PDF: rapih, padat, tidak ‚Äúkebesaran‚Äù */
    .rtable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .rtable thead th{
      background: rgba(30,99,214,.08);
      color: var(--p-ink);
      font-size:11px;
      font-weight:900;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(15,23,42,.10);
    }
    .rtable tbody td{
      font-size:11px;
      padding:10px 10px;
      vertical-align:top;
      border-bottom:1px solid rgba(15,23,42,.08);
    }
    .rtable tbody tr:last-child td{ border-bottom:none; }
    .rnote{
      font-size:11px;
      color: var(--p-muted);
      margin-top:6px;
    }

    /* chart cards di PDF */
    .pdf-chart-grid{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .chart-card{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .chart-top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .chart-top .t{
      font-weight:950;
      font-size:12px;
    }
    .chart-top .m{
      font-size:11px;
      color: var(--p-muted);
      white-space:nowrap;
    }

    .pdf-footer{
      margin-top:auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      font-size:10px;
      color: var(--p-muted);
      padding-top:8px;
      border-top:1px solid rgba(15,23,42,.08);
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="pbrand">
        <img src="assets/logo-innoviyup.png" alt="Logo InnoviYup" />
        <div>
          <div class="b1">iYup Care</div>
          <div class="b2">Monitoring</div>
        </div>
      </div>

      <div class="pactions">
        <a class="pbtn primary" href="dashboard.html">Dashboard</a>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="back-row">
      <a class="pbtn" href="dashboard.html">‚Üê Kembali</a>
    </div>

    <div style="margin-top:6px;">
      <h1 style="margin-bottom:6px;">Monitoring Pertumbuhan</h1>
      <div class="small">Catat dan visualisasi BB/TB secara rutin.</div>

      <div class="header-tools">
        <div class="card child-card">
          <div class="field">
            <label>Pilih Anak</label>
            <select id="anakSelect"></select>
          </div>

          <!-- ‚úÖ 3 tombol: tambah / edit / hapus -->
          <button class="btn secondary" type="button" id="btnTambahAnak">+ Tambah Anak</button>
          <button class="btn secondary" type="button" id="btnEditAnak">Edit Anak</button>
          <button class="btn secondary" type="button" id="btnHapusAnak">Hapus Anak</button>
        </div>

        <div class="right-tools">
          <button class="btn" type="button" id="btnUnduhPdf">
            <span id="btnPdfText">Unduh PDF</span>
            <span id="btnPdfSpin" class="spinner" style="display:none;"></span>
          </button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px" id="tabsRoot">
      <div class="tabs">
        <button class="tab" data-tab="input" type="button">Input Data</button>
        <button class="tab" data-tab="riwayat" type="button">Riwayat</button>
        <button class="tab" data-tab="grafik" type="button">Grafik</button>
        <button class="tab" data-tab="galeri" type="button">Galeri</button>
      </div>

      <!-- INPUT -->
      <div class="tab-panel" data-panel="input">
        <div id="msg"></div>

        <div class="input-actions">
          <button class="btn secondary" type="button" id="btnToggleInput">+ Input Data Anak</button>
          <div class="small small-muted" id="inputHint">Klik untuk membuka form input.</div>
        </div>

        <form id="formMonitoring" class="hidden">
          <div class="grid grid-2">
            <div>
              <label>Tanggal Ukur</label>
              <input id="tanggal" type="date" />
            </div>
            <div>
              <label>Berat Badan (kg)</label>
              <input id="berat_badan" type="number" step="0.1" min="1" />
            </div>
            <div>
              <label>Tinggi Badan (cm)</label>
              <input id="tinggi_badan" type="number" step="0.1" min="30" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Catatan (opsional)</label>
            <textarea id="catatan" rows="3" placeholder="Mis: anak kurang nafsu makan, baru imunisasi, dll."></textarea>
          </div>

          <div class="row" style="margin-top:12px; gap:10px;">
            <button class="btn" type="submit" id="btnSimpanMonitoring">
              <span id="btnSimpanMonText">Simpan Data</span>
              <span id="btnSimpanMonSpin" class="spinner" style="display:none;"></span>
            </button>
            <button class="btn secondary" type="button" id="btnBatalInput">Tutup</button>
          </div>
        </form>

        <div class="dbwrap">
          <div class="small" style="margin-bottom:8px;">Data tersimpan (format tabel monitoring)</div>
          <table class="table">
            <thead>
              <tr>
                <th>id</th>
                <th>anak_id</th>
                <th>tanggal_ukur</th>
                <th>berat_badan</th>
                <th>tinggi_badan</th>
                <th>catatan</th>
                <th>created_at</th>
                <th>updated_at</th>
              </tr>
            </thead>
            <tbody id="dbBody">
              <tr><td colspan="8" class="small">Pilih anak, lalu input data untuk melihat baris tersimpan.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- RIWAYAT -->
      <div class="tab-panel" data-panel="riwayat">
        <div class="small">Riwayat data akan tampil di bawah.</div>
        <div style="margin-top:12px; overflow:auto">
          <table class="table">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>BB (kg)</th>
                <th>TB (cm)</th>
                <th>Catatan</th>
              </tr>
            </thead>
            <tbody id="riwayatBody">
              <tr><td colspan="4" class="small">Pilih anak untuk memuat data.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- GRAFIK -->
      <div class="tab-panel" data-panel="grafik">
        <div class="small">Grafik BB/TB otomatis mengikuti data input.</div>
        <div style="margin-top:12px">
          <canvas id="chartBB" height="130"></canvas>
          <div style="height:14px"></div>
          <canvas id="chartTB" height="130"></canvas>
          <div class="small" id="chartHint" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- GALERI -->
      <div class="tab-panel" data-panel="galeri">
        <div class="small">Upload foto untuk anak yang dipilih. Foto disimpan di Google Drive dan tampil di sini.</div>

        <div class="card" style="margin-top:12px; padding:14px;">
          <div class="grid grid-2">
            <div>
              <label>Pilih Foto</label>
              <input id="galeriFile" type="file" accept="image/*" />
              <div class="small small-muted">Format: JPG/PNG/WEBP, maks 5MB.</div>
            </div>

            <div>
              <label>Caption (opsional)</label>
              <input id="galeriCaption" type="text" placeholder="mis: bulan 1" />
              <div class="small small-muted">Max 200 karakter.</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px; gap:10px;">
            <button class="btn" type="button" id="btnUploadGaleri">Upload Foto</button>
            <div class="small" id="galeriMsg"></div>
          </div>
        </div>

        <div class="grid grid-3" style="margin-top:12px" id="galeriGrid">
          <div class="card">üì∑ Belum ada foto<br><span class="small">Upload foto pertama untuk anak ini.</span></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="small">¬© <span id="year"></span> iYup Care</div>
    </div>
  </div>

  <!-- MODAL: TAMBAH/EDIT ANAK -->
  <div class="modal-backdrop" id="modalAnak">
    <div class="modal">
      <h3>Tambah Anak</h3>
      <div class="hr"></div>

      <div id="modalMsg"></div>

      <div class="grid grid-2">
        <div style="grid-column:1 / -1">
          <label>Nama Anak</label>
          <input id="anakNama" type="text" placeholder="Mis: Caca" />
        </div>

        <div>
          <label>Tanggal Lahir</label>
          <input id="anakTglLahir" type="date" />
        </div>

        <div>
          <label>Jenis Kelamin</label>
          <select id="anakJK">
            <option value="">- pilih -</option>
            <option value="Laki-laki">Laki-laki</option>
            <option value="Perempuan">Perempuan</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:flex-end; gap:8px;">
        <button class="btn secondary" type="button" id="btnBatalModal">Batal</button>
        <button class="btn" type="button" id="btnSimpanAnak">
          <span id="btnSimpanAnakText">Simpan</span>
          <span id="btnSimpanAnakSpin" class="spinner" style="display:none;"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- =========================================================
       PDF PAGE 1 (A4 SHEET): IDENTITAS + SUMMARY + TABEL
  ========================================================== -->
  <div id="reportPage1" class="pdf-sheet" aria-hidden="true">
    <div class="pdf-card">
      <div class="pdf-header">
        <div class="pdf-brand">
          <img class="pdf-logo" id="pdfLogo1" src="assets/logo-innoviyup.png" alt="Logo" />
          <div style="min-width:0">
            <h2 class="pdf-title">Laporan Monitoring</h2>
            <div class="pdf-sub" id="reportMeta">‚Äî</div>
          </div>
        </div>
        <div class="pdf-meta-right" id="reportRightMeta">‚Äî</div>
      </div>

      <div class="pdf-chips" id="reportIdentityChips"></div>

      <div class="pdf-summary" id="reportSummary"></div>

      <div class="pdf-section-title">Riwayat Pengukuran</div>
      <div id="reportRiwayat"></div>
      <div class="rnote" id="reportNote" style="display:none;"></div>

      <div class="pdf-footer">
        <div id="reportFooterLeft">iYup Care</div>
        <div id="reportFooterRight">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       PDF PAGE 2 (A4 SHEET): GRAFIK (FULL WIDTH)
  ========================================================== -->
  <div id="reportPage2" class="pdf-sheet" aria-hidden="true">
    <div class="pdf-card">
      <div class="pdf-header">
        <div class="pdf-brand">
          <img class="pdf-logo" id="pdfLogo2" src="assets/logo-innoviyup.png" alt="Logo" />
          <div style="min-width:0">
            <h2 class="pdf-title">Grafik Pertumbuhan</h2>
            <div class="pdf-sub" id="reportChartMeta">‚Äî</div>
          </div>
        </div>
        <div class="pdf-meta-right" id="reportChartRightMeta">‚Äî</div>
      </div>

      <div class="pdf-chart-grid">
        <div class="chart-card">
          <div class="chart-top">
            <div class="t">Berat Badan (kg)</div>
            <div class="m" id="reportBbMini">‚Äî</div>
          </div>
          <canvas id="reportChartBB" width="738" height="240"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-top">
            <div class="t">Tinggi Badan (cm)</div>
            <div class="m" id="reportTbMini">‚Äî</div>
          </div>
          <canvas id="reportChartTB" width="738" height="240"></canvas>
        </div>
      </div>

      <div class="pdf-footer">
        <div>iYup Care</div>
        <div id="reportFooterRight2">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- app -->
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/app.js"></script>

  <script>
    // ===========================
    // CONFIG (ukuran vs kualitas)
    // ===========================
    const PDF_SCREENSHOT_SCALE = 1.25;
    const PDF_JPEG_QUALITY = 0.78;
    const PDF_MAX_TABLE_ROWS = 10;

    const GALERI_MAX_W = 900;
    const GALERI_JPEG_QUALITY = 0.70;

    // ===========================
    // Auth + year
    // ===========================
    requireAuthOrRedirect();
    document.getElementById("year").textContent = new Date().getFullYear();

    // ===========================
    // Helpers: api base + token
    // ===========================
    function getApiBase(){
      const meta = document.querySelector('meta[name="api-base"]');
      const base = meta?.getAttribute("content") || "";
      return base.replace(/\/+$/,"");
    }
    function mustToken(){
      const t = (typeof window.getToken === "function") ? window.getToken() : null;
      if(!t) throw new Error("Token login tidak ditemukan. Silakan login ulang.");
      return t;
    }
    async function apiMultipart(path, formData){
      const base = getApiBase();
      const url = `${base}${path.startsWith("/") ? "" : "/"}${path}`;
      const token = mustToken();

      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json",
        },
        body: formData
      });

      let payload = null;
      try { payload = await resp.json(); } catch(e){}

      if(!resp.ok){
        const msg = payload?.message || `Request gagal (${resp.status})`;
        const err = new Error(msg);
        err.status = resp.status;
        err.payload = payload;
        throw err;
      }
      return payload;
    }

    // ===========================
    // Fallback toISODate
    // ===========================
    if(typeof window.toISODate !== "function"){
      window.toISODate = function(d){
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      }
    }

    // ===========================
    // Tabs fallback
    // ===========================
    function setupTabsSafe(rootId){
      if(typeof window.setupTabs === "function"){
        window.setupTabs(rootId);
        const root = document.getElementById(rootId);
        const tabs = root?.querySelectorAll("[data-tab]") || [];
        const panels = root?.querySelectorAll("[data-panel]") || [];
        function syncActive(name){
          panels.forEach(p => p.classList.toggle("active", p.getAttribute("data-panel") === name));
          tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === name));
        }
        const activeTab = Array.from(tabs).find(t => t.classList.contains("active")) || tabs[0];
        if(activeTab) syncActive(activeTab.getAttribute("data-tab"));
        tabs.forEach(t => t.addEventListener("click", () => syncActive(t.getAttribute("data-tab"))));
        return;
      }

      const root = document.getElementById(rootId);
      if(!root) return;
      const tabs = root.querySelectorAll("[data-tab]");
      const panels = root.querySelectorAll("[data-panel]");
      function activate(name){
        tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === name));
        panels.forEach(p => p.classList.toggle("active", p.getAttribute("data-panel") === name));
      }
      tabs.forEach(t => t.addEventListener("click", () => activate(t.getAttribute("data-tab"))));
      if(tabs[0]) activate(tabs[0].getAttribute("data-tab"));
    }
    setupTabsSafe("tabsRoot");

    // ===========================
    // Elements
    // ===========================
    const anakSelect = document.getElementById("anakSelect");
    const riwayatBody = document.getElementById("riwayatBody");
    const dbBody = document.getElementById("dbBody");
    const msg = document.getElementById("msg");
    const chartHint = document.getElementById("chartHint");

    const galeriGrid = document.getElementById("galeriGrid");
    const galeriFile = document.getElementById("galeriFile");
    const galeriCaption = document.getElementById("galeriCaption");
    const btnUploadGaleri = document.getElementById("btnUploadGaleri");
    const galeriMsg = document.getElementById("galeriMsg");

    const btnUnduhPdf = document.getElementById("btnUnduhPdf");
    const btnPdfText = document.getElementById("btnPdfText");
    const btnPdfSpin = document.getElementById("btnPdfSpin");

    // tombol child actions
    const btnEditAnak = document.getElementById("btnEditAnak");
    const btnHapusAnak = document.getElementById("btnHapusAnak");

    let chartBB = null;
    let chartTB = null;

    function showMsg(text, kind="ok"){
      msg.innerHTML = `<div class="badge ${kind==="ok" ? "green" : "red"}" style="margin-bottom:10px">${text}</div>`;
    }
    function showModalError(text){
      document.getElementById("modalMsg").innerHTML =
        `<div class="badge red" style="margin-bottom:10px">${text}</div>`;
    }
    function setGaleriMsg(text, kind="ok"){
      galeriMsg.innerHTML = text
        ? `<span class="badge ${kind==="ok" ? "green" : "red"}">${text}</span>`
        : "";
    }
    function setPdfLoading(isLoading){
      btnUnduhPdf.disabled = isLoading;
      btnPdfSpin.style.display = isLoading ? "inline-block" : "none";
      btnPdfText.textContent = isLoading ? "Memproses..." : "Unduh PDF";
    }

    // ===========================
    // Spinner tombol "Simpan Data" (Monitoring)
    // ===========================
    const btnSimpanMonitoring = document.getElementById("btnSimpanMonitoring");
    const btnSimpanMonText = document.getElementById("btnSimpanMonText");
    const btnSimpanMonSpin = document.getElementById("btnSimpanMonSpin");

    function setMonitoringSaveLoading(isLoading){
      if(!btnSimpanMonitoring || !btnSimpanMonText || !btnSimpanMonSpin) return;
      btnSimpanMonitoring.disabled = isLoading;
      btnSimpanMonSpin.style.display = isLoading ? "inline-block" : "none";
      btnSimpanMonText.textContent = isLoading ? "Menyimpan..." : "Simpan Data";
    }

    // ===========================
    // Helpers: escape + umur
    // ===========================
    function escHtml(s){
      return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    function calcAgeText(birthISO){
      if(!birthISO) return "-";
      const b = new Date(String(birthISO).slice(0,10) + "T00:00:00");
      if(Number.isNaN(b.getTime())) return "-";
      const now = new Date();
      let years = now.getFullYear() - b.getFullYear();
      let months = now.getMonth() - b.getMonth();
      let days = now.getDate() - b.getDate();

      if(days < 0){
        months -= 1;
        const prevMonthDays = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
        days = prevMonthDays + days;
      }
      if(months < 0){
        years -= 1;
        months += 12;
      }
      years = Math.max(0, years);
      months = Math.max(0, months);

      if(years === 0) return `${months} bulan`;
      if(months === 0) return `${years} tahun`;
      return `${years} tahun ${months} bulan`;
    }

    function pick(obj, paths, fallback = null){
      for(const p of paths){
        const parts = p.split(".");
        let cur = obj;
        let ok = true;
        for(const part of parts){
          if(cur && Object.prototype.hasOwnProperty.call(cur, part)) cur = cur[part];
          else { ok = false; break; }
        }
        if(ok && cur !== undefined && cur !== null && String(cur).trim() !== "") return cur;
      }
      return fallback;
    }

    function fmtNum(v, decimals=1){
      if(v === null || v === undefined || v === "") return "-";
      const n = Number(v);
      if(Number.isNaN(n)) return String(v);
      const p = Math.pow(10, decimals);
      return String(Math.round(n * p) / p);
    }

    async function getUserNameForPdf(){
      try{
        const me = await api("/me", { method:"GET", auth:true });
        const name1 = pick(me, ["data.name","name","data.user.name","user.name"], null);
        if(name1) return name1;
      }catch(e){}
      try{
        const u = await api("/user", { method:"GET", auth:true });
        const name2 = pick(u, ["data.name","name","data.user.name","user.name"], null);
        if(name2) return name2;
      }catch(e){}
      return "‚Äî";
    }

    async function getAnakDetailForPdf(anakId){
      const res = await api(`/anak/${anakId}`, { method:"GET", auth:true });
      const anak = res?.data || res || {};
      const nama = pick(anak, ["nama_anak","name","nama"], "‚Äî");
      const jk   = pick(anak, ["jenis_kelamin","jk","gender"], "‚Äî");
      const tgl  = pick(anak, ["tanggal_lahir","tgl_lahir","birth_date"], null);
      return { nama, jk, tanggal_lahir: tgl };
    }

    // ===========================
    // Input toggle
    // ===========================
    const btnToggleInput = document.getElementById("btnToggleInput");
    const formMonitoring = document.getElementById("formMonitoring");
    const inputHint = document.getElementById("inputHint");
    const btnBatalInput = document.getElementById("btnBatalInput");

    function openInput(){
      formMonitoring.classList.remove("hidden");
      inputHint.textContent = "Isi data, lalu klik Simpan Data.";
      document.getElementById("tanggal").value = toISODate(new Date());
      document.getElementById("berat_badan").focus();
    }
    function closeInput(){
      formMonitoring.classList.add("hidden");
      inputHint.textContent = "Klik untuk membuka form input.";
    }
    btnToggleInput.addEventListener("click", () => {
      if(formMonitoring.classList.contains("hidden")) openInput();
      else closeInput();
    });
    btnBatalInput.addEventListener("click", closeInput);

    // ===========================
    // Render DB table
    // ===========================
    function renderDbTable(list){
      if(!list.length){
        dbBody.innerHTML = `<tr><td colspan="8" class="small">Belum ada data monitoring untuk anak ini.</td></tr>`;
        return;
      }
      dbBody.innerHTML = list.slice().reverse().map(x => `
        <tr>
          <td>${x.id ?? "-"}</td>
          <td>${x.anak_id ?? "-"}</td>
          <td>${String(x.tanggal_ukur ?? "").slice(0,10) || "-"}</td>
          <td>${x.berat_badan ?? "-"}</td>
          <td>${x.tinggi_badan ?? "-"}</td>
          <td>${escHtml((x.catatan ?? "").toString().slice(0,40) || "-")}</td>
          <td>${x.created_at ? String(x.created_at).replace("T"," ").slice(0,19) : "-"}</td>
          <td>${x.updated_at ? String(x.updated_at).replace("T"," ").slice(0,19) : "-"}</td>
        </tr>
      `).join("");
    }

    // ===========================
    // Galeri: render + load + upload
    // ===========================
    function renderGaleriGrid(items){
      if(!items || !items.length){
        galeriGrid.innerHTML = `<div class="card">üì∑ Belum ada foto<br><span class="small">Upload foto pertama untuk anak ini.</span></div>`;
        return;
      }

      galeriGrid.innerHTML = items.map(it => {
        const fid = it.drive_file_id || "";
        const thumbUrl = fid
          ? `https://drive.google.com/thumbnail?id=${encodeURIComponent(fid)}&sz=w1000`
          : (it.public_url || "");

        const openUrl = it.public_url || "#";
        const titleRaw = it.caption ? it.caption : (it.original_name || "Foto");
        const title = escHtml(titleRaw);
        const dt = it.created_at ? String(it.created_at).replace("T"," ").slice(0,16) : "";
        const original = it.original_name ? escHtml(String(it.original_name).slice(0,40)) : "";

        return `
          <div class="card galeri-item">
            <a href="${openUrl}" target="_blank" rel="noreferrer">
              <img src="${thumbUrl}" alt="${title}" loading="lazy" />
            </a>
            <div class="galeri-meta">
              <div>
                <div class="galeri-caption">${title}</div>
                <div class="small small-muted">${original}</div>
              </div>
              <div class="galeri-date">${dt}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    async function loadGaleriByAnak(anakId){
      if(!anakId) return [];
      setGaleriMsg("Memuat galeri...", "ok");
      try{
        const res = await api(`/anak/${anakId}/galeri`, { method:"GET", auth:true });
        const items = res?.data || [];
        renderGaleriGrid(items);
        setGaleriMsg("", "ok");
        return items;
      }catch(err){
        console.error(err);
        setGaleriMsg(err?.payload?.message || err.message || "Gagal memuat galeri.", "err");
        renderGaleriGrid([]);
        return [];
      }
    }

    async function uploadGaleriForAnak(anakId){
      const f = galeriFile.files?.[0];
      const cap = (galeriCaption.value || "").trim();

      if(!anakId){ setGaleriMsg("Pilih anak dulu.", "err"); return; }
      if(!f){ setGaleriMsg("Pilih file foto dulu.", "err"); return; }

      const allowed = ["image/jpeg","image/png","image/webp"];
      if(!allowed.includes(f.type)){ setGaleriMsg("Format harus JPG/PNG/WEBP.", "err"); return; }
      const max = 5 * 1024 * 1024;
      if(f.size > max){ setGaleriMsg("Ukuran file maksimal 5MB.", "err"); return; }
      if(cap.length > 200){ setGaleriMsg("Caption maksimal 200 karakter.", "err"); return; }

      const fd = new FormData();
      fd.append("file", f);
      if(cap) fd.append("caption", cap);

      btnUploadGaleri.disabled = true;
      setGaleriMsg("Mengupload...", "ok");

      try{
        await apiMultipart(`/anak/${anakId}/galeri`, fd);
        galeriFile.value = "";
        galeriCaption.value = "";

        setGaleriMsg("Upload sukses. Memuat ulang galeri...", "ok");
        await loadGaleriByAnak(anakId);
        setGaleriMsg("Upload sukses.", "ok");
      }catch(err){
        console.error(err);
        const errors = err?.payload?.errors;
        const detail = errors
          ? Object.entries(errors).map(([k,v]) => `${k}: ${Array.isArray(v)?v.join(", "):v}`).join(" | ")
          : "";
        setGaleriMsg(detail || err?.payload?.message || err.message || "Upload gagal.", "err");
      }finally{
        btnUploadGaleri.disabled = false;
      }
    }

    btnUploadGaleri.addEventListener("click", async () => {
      const anakId = anakSelect.value;
      await uploadGaleriForAnak(anakId);
    });

    // ===========================
    // Render riwayat + grafik
    // ===========================
    async function renderRiwayatAndCharts(anakId){
      riwayatBody.innerHTML = `<tr><td colspan="4" class="small">Memuat...</td></tr>`;
      dbBody.innerHTML = `<tr><td colspan="8" class="small">Memuat...</td></tr>`;
      chartHint.textContent = "";

      const list = await loadMonitoringByAnak(anakId);

      if(!list.length){
        riwayatBody.innerHTML = `<tr><td colspan="4" class="small">Belum ada data monitoring.</td></tr>`;
        renderDbTable([]);
        chartHint.textContent = "Belum ada data untuk digrafikkan.";
        if(chartBB) chartBB.destroy();
        if(chartTB) chartTB.destroy();
        return;
      }

      list.sort((a,b) => String(a.tanggal_ukur).localeCompare(String(b.tanggal_ukur)));

      riwayatBody.innerHTML = list.slice().reverse().map(x => `
        <tr>
          <td>${String(x.tanggal_ukur ?? "").slice(0,10) || "-"}</td>
          <td>${x.berat_badan ?? "-"}</td>
          <td>${x.tinggi_badan ?? "-"}</td>
          <td>${escHtml((x.catatan ?? "").toString().slice(0,60) || "-")}</td>
        </tr>
      `).join("");

      renderDbTable(list);

      const labels = list.map(x => String(x.tanggal_ukur ?? "").slice(0,10) || "‚Äî");
      const weights = list.map(x => Number(x.berat_badan ?? 0));
      const heights = list.map(x => Number(x.tinggi_badan ?? 0));

      if(typeof Chart === "undefined"){
        chartHint.textContent = "Chart.js tidak tersedia.";
        return;
      }

      if(chartBB) chartBB.destroy();
      if(chartTB) chartTB.destroy();

      chartBB = new Chart(document.getElementById("chartBB"), {
        type:"line",
        data:{ labels, datasets:[{ label:"BB (kg)", data:weights, tension:.35 }] },
        options:{ responsive:true, plugins:{ legend:{display:false} } }
      });

      chartTB = new Chart(document.getElementById("chartTB"), {
        type:"line",
        data:{ labels, datasets:[{ label:"TB (cm)", data:heights, tension:.35 }] },
        options:{ responsive:true, plugins:{ legend:{display:false} } }
      });

      chartHint.textContent = "Grafik otomatis mengikuti data input (entry pertama sampai terakhir).";
    }

    // ===========================
    // Init anak dropdown
    // ===========================
    (async () => {
      await loadAnakList("anakSelect");

      anakSelect.addEventListener("change", async () => {
        const id = anakSelect.value;
        if(!id) return;
        await renderRiwayatAndCharts(id);
        await loadGaleriByAnak(id);
      });

      if(anakSelect.options.length > 1){
        anakSelect.selectedIndex = 1;
        const id = anakSelect.value;
        await renderRiwayatAndCharts(id);
        await loadGaleriByAnak(id);
      } else {
        renderGaleriGrid([]);
      }
    })();

    // ===========================
    // Submit monitoring (spinner aktif selama request)
    // ===========================
    document.getElementById("formMonitoring").addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.innerHTML = "";

      const anakId = anakSelect.value;
      if(!anakId){
        showMsg("Pilih anak dulu sebelum menyimpan.", "err");
        return;
      }

      const payload = {
        tanggal_ukur: document.getElementById("tanggal").value || null,
        berat_badan: Number(document.getElementById("berat_badan").value),
        tinggi_badan: Number(document.getElementById("tinggi_badan").value),
        catatan: document.getElementById("catatan").value?.trim() || null,
      };

      setMonitoringSaveLoading(true);
      try{
        await api(`/anak/${anakId}/monitoring`, { method:"POST", body:payload, auth:true });
        showMsg("Data berhasil disimpan.", "ok");

        document.getElementById("berat_badan").value = "";
        document.getElementById("tinggi_badan").value = "";
        document.getElementById("catatan").value = "";

        await renderRiwayatAndCharts(anakId);
        closeInput();
      }catch(err){
        const errors = err?.payload?.errors;
        const detail = errors
          ? Object.entries(errors).map(([k,v]) => `${k}: ${Array.isArray(v)?v.join(", "):v}`).join(" | ")
          : "";
        showMsg(detail || err.message || "Gagal menyimpan.", "err");
        console.error(err);
      }finally{
        setMonitoringSaveLoading(false);
      }
    });

    // ===========================
    // Modal tambah/edit anak + loading
    // ===========================
    const modal = document.getElementById("modalAnak");
    const anakNama = document.getElementById("anakNama");
    const anakTglLahir = document.getElementById("anakTglLahir");
    const anakJK = document.getElementById("anakJK");

    const btnSimpanAnak = document.getElementById("btnSimpanAnak");
    const btnSimpanAnakText = document.getElementById("btnSimpanAnakText");
    const btnSimpanAnakSpin = document.getElementById("btnSimpanAnakSpin");

    function setChildSaveLoading(isLoading){
      btnSimpanAnak.disabled = isLoading;
      document.getElementById("btnBatalModal").disabled = isLoading;
      btnSimpanAnakSpin.style.display = isLoading ? "inline-block" : "none";
      btnSimpanAnakText.textContent = isLoading ? "Menyimpan" : "Simpan";
    }

    function closeModal(){ modal.style.display = "none"; }

    document.getElementById("btnBatalModal").addEventListener("click", () => {
      if(btnSimpanAnak.disabled) return;
      closeModal();
    });
    modal.addEventListener("click", (e) => {
      if(e.target === modal && !btnSimpanAnak.disabled) closeModal();
    });

    function normalizeGender(v){
      const s = String(v || "").trim();
      if(s === "Laki-laki" || s === "Perempuan") return s;
      const lower = s.toLowerCase();
      if(["l","lk","laki","laki-laki","male"].includes(lower)) return "Laki-laki";
      if(["p","pr","perempuan","female"].includes(lower)) return "Perempuan";
      return s;
    }

    // ===========================
    // Mode modal: create vs edit
    // ===========================
    let modalMode = "create"; // "create" | "edit"
    let editingAnakId = null;

    function setModalTitle(t){
      const h = modal.querySelector("h3");
      if(h) h.textContent = t;
    }

    function openModalCreate(){
      modalMode = "create";
      editingAnakId = null;

      document.getElementById("modalMsg").innerHTML = "";
      anakNama.value = "";
      anakTglLahir.value = "";
      anakJK.value = "";

      modal.style.display = "flex";
      setChildSaveLoading(false);
      setModalTitle("Tambah Anak");
      setTimeout(() => anakNama.focus(), 10);
    }

    function openModalEdit(anak){
      modalMode = "edit";
      editingAnakId = anak?.id;

      document.getElementById("modalMsg").innerHTML = "";
      anakNama.value = anak?.nama_anak || anak?.name || anak?.nama || "";
      anakTglLahir.value = String(anak?.tanggal_lahir || anak?.tgl_lahir || anak?.birth_date || "").slice(0,10);
      anakJK.value = normalizeGender(anak?.jenis_kelamin || anak?.jk || anak?.gender || "");

      modal.style.display = "flex";
      setChildSaveLoading(false);
      setModalTitle("Edit Anak");
      setTimeout(() => anakNama.focus(), 10);
    }

    // tombol tambah anak -> create
    document.getElementById("btnTambahAnak").addEventListener("click", openModalCreate);

    // tombol edit anak
    btnEditAnak.addEventListener("click", async () => {
      const anakId = anakSelect.value;
      if(!anakId){ showMsg("Pilih anak dulu.", "err"); return; }

      try{
        const res = await api(`/anak/${anakId}`, { method:"GET", auth:true });
        const anak = res?.data || res;
        openModalEdit(anak);
      }catch(err){
        showMsg(err.message || "Gagal memuat detail anak.", "err");
        console.error(err);
      }
    });

    // tombol hapus anak
    btnHapusAnak.addEventListener("click", async () => {
      const anakId = anakSelect.value;
      if(!anakId){ showMsg("Pilih anak dulu.", "err"); return; }

      const ok = confirm("Yakin ingin menghapus data anak ini? Data monitoring & galeri bisa ikut hilang tergantung backend.");
      if(!ok) return;

      try{
        await api(`/anak/${anakId}`, { method:"DELETE", auth:true });
        showMsg("Anak berhasil dihapus.", "ok");

        await loadAnakList("anakSelect");
        if(anakSelect.options.length > 1){
          anakSelect.selectedIndex = 1;
          const id = anakSelect.value;
          await renderRiwayatAndCharts(id);
          await loadGaleriByAnak(id);
        }else{
          riwayatBody.innerHTML = `<tr><td colspan="4" class="small">Belum ada data.</td></tr>`;
          renderDbTable([]);
          renderGaleriGrid([]);
          chartHint.textContent = "";
          if(chartBB) chartBB.destroy();
          if(chartTB) chartTB.destroy();
        }
      }catch(err){
        showMsg(err.message || "Gagal menghapus anak.", "err");
        console.error(err);
      }
    });

    // simpan anak (create/edit)
    btnSimpanAnak.addEventListener("click", async () => {
      const nama = anakNama.value.trim();
      const tgl  = anakTglLahir.value;
      const jk   = normalizeGender(anakJK.value);

      if(!nama){ showModalError("Nama anak wajib diisi."); return; }
      if(!tgl){ showModalError("Tanggal lahir wajib diisi."); return; }
      if(!jk){ showModalError("Jenis kelamin wajib dipilih."); return; }

      const body = { nama_anak: nama, tanggal_lahir: tgl, jenis_kelamin: jk };

      try{
        setChildSaveLoading(true);

        if(modalMode === "create"){
          const created = await api("/anak", { method:"POST", auth:true, body });

          closeModal();
          showMsg("Anak berhasil ditambahkan.", "ok");

          await loadAnakList("anakSelect");
          const newId = created?.data?.id || created?.id;
          if(newId) anakSelect.value = String(newId);
          else anakSelect.selectedIndex = Math.max(0, anakSelect.options.length - 1);

          const chosenId = anakSelect.value;
          if(chosenId){
            await renderRiwayatAndCharts(chosenId);
            await loadGaleriByAnak(chosenId);
          }else{
            renderDbTable([]);
            renderGaleriGrid([]);
          }
        } else {
          if(!editingAnakId) throw new Error("ID anak tidak valid untuk edit.");

          await api(`/anak/${editingAnakId}`, { method:"PUT", auth:true, body });

          closeModal();
          showMsg("Data anak berhasil diperbarui.", "ok");

          const keepId = String(editingAnakId);
          await loadAnakList("anakSelect");
          anakSelect.value = keepId;

          await renderRiwayatAndCharts(keepId);
          await loadGaleriByAnak(keepId);
        }

      }catch(err){
        const errors = err?.payload?.errors;
        const detail = errors
          ? Object.entries(errors).map(([k,v]) => `${k}: ${Array.isArray(v)?v.join(", "):v}`).join(" | ")
          : "";
        showModalError(detail || err.message || "Gagal menyimpan.");
        console.error(err);
      }finally{
        setChildSaveLoading(false);
      }
    });

    // ===========================
    // PDF helpers: tunggu img load (logo)
    // ===========================
    function waitImagesLoaded(rootEl){
      const imgs = Array.from(rootEl.querySelectorAll("img"));
      return Promise.all(imgs.map(img => {
        if(img.complete && img.naturalWidth > 0) return Promise.resolve();
        return new Promise(res => {
          img.onload = () => res();
          img.onerror = () => res();
        });
      }));
    }

    // ===========================
    // PDF helpers: screenshot DOM -> JPEG (return dim)
    // ===========================
    async function domToJpegData(el){
      const canvas = await html2canvas(el, {
        scale: PDF_SCREENSHOT_SCALE,
        useCORS: true,
        backgroundColor: "#ffffff"
      });
      return {
        dataUrl: canvas.toDataURL("image/jpeg", PDF_JPEG_QUALITY),
        w: canvas.width,
        h: canvas.height
      };
    }

    // Add image to page WITHOUT distorsi (fit)
    function addJpegFitToPage(pdf, jpegObj, margin = 0){
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const maxW = pageW - margin*2;
      const maxH = pageH - margin*2;

      const imgRatio = jpegObj.w / jpegObj.h;

      let w = maxW;
      let h = w / imgRatio;
      if(h > maxH){
        h = maxH;
        w = h * imgRatio;
      }

      const x = (pageW - w) / 2;
      const y = margin;
      pdf.addImage(jpegObj.dataUrl, "JPEG", x, y, w, h, undefined, "FAST");
    }

    // ===========================
    // PDF helpers: URL image -> JPEG compressed (auth)
    // ===========================
    async function imgUrlToJpegData(url, maxW = GALERI_MAX_W, quality = GALERI_JPEG_QUALITY){
      const token = mustToken();
      const resp = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
      if(!resp.ok) throw new Error(`Gagal ambil gambar (${resp.status})`);
      const blob = await resp.blob();

      const bitmap = await createImageBitmap(blob);

      const ratio = bitmap.width / bitmap.height;
      const w = Math.min(maxW, bitmap.width);
      const h = Math.round(w / ratio);

      const c = document.createElement("canvas");
      c.width = w;
      c.height = h;
      const ctx = c.getContext("2d");
      ctx.drawImage(bitmap, 0, 0, w, h);

      return c.toDataURL("image/jpeg", quality);
    }

    // ===========================
    // PDF: tambah halaman galeri (6 foto per halaman)
    // ===========================
    async function addGaleriPagesToPdf(pdf, galeriList){
      const base = getApiBase();
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const margin = 10;
      const gap = 6;

      const cols = 2;
      const rows = 3;
      const perPage = cols * rows;

      const titleH = 10;
      const capH = 6;

      const cellW = (pageW - margin*2 - gap*(cols-1)) / cols;
      const cellH = (pageH - margin*2 - titleH - capH - gap*(rows-1)) / rows;

      for(let i=0; i<galeriList.length; i += perPage){
        pdf.addPage();
        pdf.setFontSize(14);
        pdf.text("Galeri Foto", margin, margin + 6);

        const slice = galeriList.slice(i, i+perPage);

        for(let j=0; j<slice.length; j++){
          const it = slice[j];
          const r = Math.floor(j / cols);
          const c = j % cols;

          const x = margin + c*(cellW + gap);
          const y = margin + titleH + r*(cellH + gap);

          const imgUrl = `${base}/galeri/${encodeURIComponent(it.id)}/image`;

          try{
            const jpeg = await imgUrlToJpegData(imgUrl, GALERI_MAX_W, GALERI_JPEG_QUALITY);
            pdf.addImage(jpeg, "JPEG", x, y, cellW, cellH, undefined, "FAST");
          }catch(e){
            pdf.setFontSize(10);
            pdf.text("Gagal memuat foto", x, y + 10);
          }

          const cap = (it.caption || it.original_name || "").toString().slice(0, 28);
          if(cap){
            pdf.setFontSize(9);
            pdf.text(cap, x, y + cellH + 4);
          }
        }
      }
    }

    // ===========================
    // PDF Export (layout rapi)
    // ===========================
    async function exportPdfForSelectedAnak(){
      const anakId = anakSelect.value;
      if(!anakId){ showMsg("Pilih anak dulu sebelum unduh PDF.", "err"); return; }

      const list = await loadMonitoringByAnak(anakId);
      if(!list.length){ showMsg("Belum ada data monitoring untuk dibuat PDF.", "err"); return; }
      list.sort((a,b) => String(a.tanggal_ukur).localeCompare(String(b.tanggal_ukur)));

      const userName = await getUserNameForPdf();
      const anakDetail = await getAnakDetailForPdf(anakId);

      const namaAnak = anakDetail?.nama ?? "‚Äî";
      const jkAnak = anakDetail?.jk ?? "‚Äî";
      const umurAnak = calcAgeText(anakDetail?.tanggal_lahir);

      const exportedAt = toISODate(new Date());
      document.getElementById("reportMeta").textContent =
        `${namaAnak} ‚Ä¢ diekspor: ${exportedAt} ‚Ä¢ total data: ${list.length}`;
      document.getElementById("reportRightMeta").textContent = `ID Anak: ${anakId}`;

      document.getElementById("reportFooterRight").textContent = `Diekspor: ${exportedAt}`;
      document.getElementById("reportFooterRight2").textContent = `Diekspor: ${exportedAt}`;
      document.getElementById("reportChartRightMeta").textContent = `Total titik: ${list.length}`;

      document.getElementById("reportIdentityChips").innerHTML = `
        <div class="pdf-chip"><span>Nama Ibu/User</span><b>${escHtml(userName)}</b></div>
        <div class="pdf-chip"><span>Nama Anak</span><b>${escHtml(namaAnak)}</b></div>
        <div class="pdf-chip"><span>Jenis Kelamin</span><b>${escHtml(jkAnak)}</b></div>
        <div class="pdf-chip"><span>Umur</span><b>${escHtml(umurAnak)}</b></div>
      `;

      const last = list[list.length - 1];
      const prev = list.length > 1 ? list[list.length - 2] : null;

      const lastDate = String(last?.tanggal_ukur ?? "").slice(0,10) || "‚Äî";
      const lastBB = fmtNum(last?.berat_badan, 1);
      const lastTB = fmtNum(last?.tinggi_badan, 1);

      let deltaBB = "‚Äî";
      let deltaTB = "‚Äî";
      if(prev){
        const dBB = Number(last?.berat_badan ?? 0) - Number(prev?.berat_badan ?? 0);
        const dTB = Number(last?.tinggi_badan ?? 0) - Number(prev?.tinggi_badan ?? 0);
        deltaBB = (Math.round(dBB*10)/10 >= 0 ? "+" : "") + (Math.round(dBB*10)/10);
        deltaTB = (Math.round(dTB*10)/10 >= 0 ? "+" : "") + (Math.round(dTB*10)/10);
      }

      document.getElementById("reportSummary").innerHTML = `
        <div class="sum">
          <div class="k">Pengukuran Terakhir</div>
          <div class="v">${escHtml(lastDate)}</div>
          <div class="s">dibuat otomatis dari data terbaru</div>
        </div>
        <div class="sum">
          <div class="k">BB Terakhir</div>
          <div class="v">${escHtml(lastBB)} kg</div>
          <div class="s">Œî dari sebelumnya: <b>${escHtml(deltaBB)}</b></div>
        </div>
        <div class="sum">
          <div class="k">TB Terakhir</div>
          <div class="v">${escHtml(lastTB)} cm</div>
          <div class="s">Œî dari sebelumnya: <b>${escHtml(deltaTB)}</b></div>
        </div>
      `;

      const newestFirst = list.slice().reverse();
      const rows = newestFirst.slice(0, PDF_MAX_TABLE_ROWS);
      const truncated = newestFirst.length > PDF_MAX_TABLE_ROWS;

      document.getElementById("reportRiwayat").innerHTML = `
        <table class="rtable">
          <thead>
            <tr>
              <th style="width:120px">Tanggal</th>
              <th style="width:90px">BB</th>
              <th style="width:90px">TB</th>
              <th>Catatan</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(x => `
              <tr>
                <td>${escHtml(String(x.tanggal_ukur ?? "").slice(0,10) || "-")}</td>
                <td>${escHtml(fmtNum(x.berat_badan, 1))}</td>
                <td>${escHtml(fmtNum(x.tinggi_badan, 1))}</td>
                <td>${escHtml((x.catatan ?? "").toString().slice(0,120) || "-")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      const noteEl = document.getElementById("reportNote");
      if(truncated){
        noteEl.style.display = "block";
        noteEl.textContent = `Menampilkan ${PDF_MAX_TABLE_ROWS} data terbaru dari total ${list.length} data.`;
      }else{
        noteEl.style.display = "none";
        noteEl.textContent = "";
      }

      document.getElementById("reportChartMeta").textContent =
        `${namaAnak} ‚Ä¢ ${jkAnak} ‚Ä¢ umur: ${umurAnak}`;

      const labels = list.map(x => String(x.tanggal_ukur ?? "").slice(0,10));
      const weights = list.map(x => Number(x.berat_badan ?? 0));
      const heights = list.map(x => Number(x.tinggi_badan ?? 0));

      const wMin = Math.min(...weights);
      const wMax = Math.max(...weights);
      const hMin = Math.min(...heights);
      const hMax = Math.max(...heights);
      document.getElementById("reportBbMini").textContent = `min ${fmtNum(wMin,1)} ‚Ä¢ max ${fmtNum(wMax,1)} ‚Ä¢ terakhir ${lastBB}`;
      document.getElementById("reportTbMini").textContent = `min ${fmtNum(hMin,1)} ‚Ä¢ max ${fmtNum(hMax,1)} ‚Ä¢ terakhir ${lastTB}`;

      if(window.__reportChartBB) window.__reportChartBB.destroy();
      if(window.__reportChartTB) window.__reportChartTB.destroy();

      const commonReportOpts = {
        responsive: false,
        devicePixelRatio: 1,
        plugins: { legend: { display:false } },
        elements: { point: { radius:2, hoverRadius:3 } },
        scales: {
          x: { ticks: { font:{ size:10 }, maxRotation:0, autoSkip:true, maxTicksLimit:7 }, grid:{ display:false } },
          y: { ticks: { font:{ size:10 } }, grid:{ color:"rgba(15,23,42,.08)" } }
        }
      };

      window.__reportChartBB = new Chart(document.getElementById("reportChartBB"), {
        type:"line",
        data:{ labels, datasets:[{ label:"BB (kg)", data:weights, tension:.35 }] },
        options: commonReportOpts
      });

      window.__reportChartTB = new Chart(document.getElementById("reportChartTB"), {
        type:"line",
        data:{ labels, datasets:[{ label:"TB (cm)", data:heights, tension:.35 }] },
        options: commonReportOpts
      });

      await waitImagesLoaded(document.getElementById("reportPage1"));
      await waitImagesLoaded(document.getElementById("reportPage2"));
      await new Promise(r => setTimeout(r, 250));

      let galeriList = [];
      try{
        const g = await api(`/anak/${anakId}/galeri`, { method:"GET", auth:true });
        galeriList = g?.data || [];
      }catch(e){
        galeriList = [];
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const page1Jpeg = await domToJpegData(document.getElementById("reportPage1"));
      addJpegFitToPage(pdf, page1Jpeg, 0);

      pdf.addPage();
      const page2Jpeg = await domToJpegData(document.getElementById("reportPage2"));
      addJpegFitToPage(pdf, page2Jpeg, 0);

      if(galeriList.length){
        await addGaleriPagesToPdf(pdf, galeriList);
      } else {
        pdf.addPage();
        pdf.setFontSize(14);
        pdf.text("Galeri Foto", 10, 16);
        pdf.setFontSize(11);
        pdf.text("Tidak ada foto.", 10, 26);
      }

      const safeName = String(namaAnak || "anak").replace(/[^\w\-]+/g, "-").toLowerCase();
      pdf.save(`laporan-monitoring-${safeName}.pdf`);
    }

    // ===========================
    // Button PDF
    // ===========================
    btnUnduhPdf.addEventListener("click", async () => {
      setPdfLoading(true);
      try{
        await exportPdfForSelectedAnak();
      }catch(err){
        showMsg(err.message || "Gagal membuat PDF.", "err");
        console.error(err);
      }finally{
        setPdfLoading(false);
      }
    });
  </script>
</body>
</html>
