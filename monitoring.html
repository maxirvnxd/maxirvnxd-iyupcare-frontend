<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- API BASE (HF) -->
  <meta name="api-base" content="https://maxirvnxd-iyupcare-backend.hf.space/api" />

  <title>Monitoring ‚Äî iYup Care</title>
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    /* ============================
      TOPBAR STYLE (selaras produk.html)
      NOTE: pakai class khusus (.pbtn) supaya TIDAK merusak .btn di styles.css
    ============================ */
    :root{
      --p-bg:#f6f9ff;
      --p-ink:#0b1b3a;
      --p-muted:#5b6b80;
      --p-line: rgba(15,23,42,.10);
      --p-shadow2: 0 12px 30px rgba(15,23,42,.08);
      --p-primary:#1e63d6;
      --p-radius:18px;
      --p-max:1100px;
    }
    body{
      background:
        radial-gradient(900px 520px at 15% 10%, rgba(30,99,214,.16), transparent 60%),
        radial-gradient(800px 520px at 90% 0%, rgba(31,157,85,.12), transparent 58%),
        radial-gradient(800px 520px at 90% 90%, rgba(242,153,74,.10), transparent 55%),
        var(--p-bg);
      color: var(--p-ink);
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .topbar-inner{
      max-width: var(--p-max);
      margin: 0 auto;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .pbrand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .pbrand img{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      object-fit: cover;
      background:#fff;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 20px rgba(15,23,42,.12);
      display:block;
    }
    .pbrand .b1{ font-weight: 950; letter-spacing:.2px; }
    .pbrand .b2{ font-size: 12px; color: var(--muted); margin-top:2px; }

    .pactions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .pbtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.80);
      font-weight: 950;
      font-size: 13px;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      white-space: nowrap;
      text-decoration:none;
      color:inherit;
    }
    .pbtn:hover{
      border-color: rgba(30,99,214,.25);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
    }
    .pbtn.primary{
      background: linear-gradient(180deg, rgba(30,99,214,1), rgba(20,76,175,1));
      border-color: rgba(30,99,214,.0);
      color:#fff;
    }
    .pbtn.primary:hover{ filter: brightness(.98); }

    /* back row ala produk.html */
    .back-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 12px 0 8px;
      flex-wrap:wrap;
    }

    /* ============================
      Monitoring page patches
    ============================ */
    textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:12px;
      outline:none;
      resize:vertical;
      background:#fff;
    }

    .header-tools{
      margin-top:12px;display:flex;gap:12px;align-items:stretch;flex-wrap:wrap;
    }
    .child-card{
      display:flex;gap:10px;align-items:flex-end;padding:12px 14px;flex:1;min-width:280px;
    }
    .child-card .field{flex:1;min-width:220px;}
    .child-card label{display:block;}
    .child-card select{width:100%;}

    .right-tools{display:flex;align-items:flex-end;}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:9999;
    }
    .modal{
      width:min(560px, 100%);background:#fff;border-radius:16px;padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.18);
    }
    .modal h3{margin:0 0 10px;}
    .hr{height:1px;background:rgba(0,0,0,.08);margin:12px 0;}

    .btn[disabled]{opacity:.7;cursor:not-allowed;}
    .spinner{
      width:16px;height:16px;border:2px solid rgba(255,255,255,.5);
      border-top-color:#fff;border-radius:50%;display:inline-block;
      animation:spin .75s linear infinite;vertical-align:middle;margin-left:8px;
    }
    @keyframes spin{to{transform:rotate(360deg);} }

    .input-actions{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin: 8px 0 10px;
    }
    .hidden{display:none !important;}

    .dbwrap{margin-top:14px;overflow:auto;}
    .small-muted{opacity:.85;}

    .tab-panel{display:none;}
    .tab-panel.active{display:block;}

    @media (max-width: 980px){
      .topbar-inner{ gap: 10px; }
      .pbrand{ min-width: 0; }
    }

    /* Galeri helpers */
    .galeri-item{ padding:12px; }
    .galeri-item img{
      width:100%;
      height:240px;
      object-fit:cover;
      border-radius:14px;
      display:block;
      background: rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.08);
    }
    .galeri-meta{
      margin-top:8px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .galeri-caption{
      font-weight:700;
      font-size:12px;
      line-height:1.2;
    }
    .galeri-date{
      font-size:12px;
      opacity:.85;
      white-space:nowrap;
    }

    /* Report images */
    .report-img{
      width:100%;
      height:180px;
      object-fit:cover;
      border-radius:12px;
      display:block;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.04);
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="pbrand">
        <img src="assets/logo-innoviyup.png" alt="Logo InnoviYup" />
        <div>
          <div class="b1">iYup Care</div>
          <div class="b2">Monitoring</div>
        </div>
      </div>

      <div class="pactions">
        <a class="pbtn primary" href="dashboard.html">Dashboard</a>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="back-row">
      <a class="pbtn" href="dashboard.html">‚Üê Kembali</a>
    </div>

    <div style="margin-top:6px;">
      <h1 style="margin-bottom:6px;">Monitoring Pertumbuhan</h1>
      <div class="small">Catat dan visualisasi BB/TB secara rutin.</div>

      <div class="header-tools">
        <div class="card child-card">
          <div class="field">
            <label>Pilih Anak</label>
            <select id="anakSelect"></select>
          </div>
          <button class="btn secondary" type="button" id="btnTambahAnak">+ Tambah Anak</button>
        </div>

        <div class="right-tools">
          <button class="btn" type="button" id="btnUnduhPdf">Unduh PDF</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px" id="tabsRoot">
      <div class="tabs">
        <button class="tab" data-tab="input" type="button">Input Data</button>
        <button class="tab" data-tab="riwayat" type="button">Riwayat</button>
        <button class="tab" data-tab="grafik" type="button">Grafik</button>
        <button class="tab" data-tab="galeri" type="button">Galeri</button>
      </div>

      <!-- INPUT -->
      <div class="tab-panel" data-panel="input">
        <div id="msg"></div>

        <div class="input-actions">
          <button class="btn secondary" type="button" id="btnToggleInput">+ Input Data Anak</button>
          <div class="small small-muted" id="inputHint">Klik untuk membuka form input.</div>
        </div>

        <form id="formMonitoring" class="hidden">
          <div class="grid grid-2">
            <div>
              <label>Tanggal Ukur</label>
              <input id="tanggal" type="date" />
            </div>
            <div>
              <label>Berat Badan (kg)</label>
              <input id="berat_badan" type="number" step="0.1" min="1" />
            </div>
            <div>
              <label>Tinggi Badan (cm)</label>
              <input id="tinggi_badan" type="number" step="0.1" min="30" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Catatan (opsional)</label>
            <textarea id="catatan" rows="3" placeholder="Mis: anak kurang nafsu makan, baru imunisasi, dll."></textarea>
          </div>

          <div class="row" style="margin-top:12px; gap:10px;">
            <button class="btn" type="submit" id="btnSimpanMonitoring">Simpan Data</button>
            <button class="btn secondary" type="button" id="btnBatalInput">Tutup</button>
          </div>
        </form>

        <div class="dbwrap">
          <div class="small" style="margin-bottom:8px;">Data tersimpan (format tabel monitoring)</div>
          <table class="table">
            <thead>
              <tr>
                <th>id</th>
                <th>anak_id</th>
                <th>tanggal_ukur</th>
                <th>berat_badan</th>
                <th>tinggi_badan</th>
                <th>catatan</th>
                <th>created_at</th>
                <th>updated_at</th>
              </tr>
            </thead>
            <tbody id="dbBody">
              <tr><td colspan="8" class="small">Pilih anak, lalu input data untuk melihat baris tersimpan.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- RIWAYAT -->
      <div class="tab-panel" data-panel="riwayat">
        <div class="small">Riwayat data akan tampil di bawah.</div>
        <div style="margin-top:12px; overflow:auto">
          <table class="table">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>BB (kg)</th>
                <th>TB (cm)</th>
                <th>Catatan</th>
              </tr>
            </thead>
            <tbody id="riwayatBody">
              <tr><td colspan="4" class="small">Pilih anak untuk memuat data.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- GRAFIK -->
      <div class="tab-panel" data-panel="grafik">
        <div class="small">Grafik BB/TB otomatis mengikuti data input.</div>
        <div style="margin-top:12px">
          <canvas id="chartBB" height="130"></canvas>
          <div style="height:14px"></div>
          <canvas id="chartTB" height="130"></canvas>
          <div class="small" id="chartHint" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- GALERI -->
      <div class="tab-panel" data-panel="galeri">
        <div class="small">Upload foto untuk anak yang dipilih. Foto disimpan di Google Drive dan tampil di sini.</div>

        <div class="card" style="margin-top:12px; padding:14px;">
          <div class="grid grid-2">
            <div>
              <label>Pilih Foto</label>
              <input id="galeriFile" type="file" accept="image/*" />
              <div class="small small-muted">Format: JPG/PNG/WEBP, maks 5MB.</div>
            </div>

            <div>
              <label>Caption (opsional)</label>
              <input id="galeriCaption" type="text" placeholder="mis: bulan 1" />
              <div class="small small-muted">Max 200 karakter.</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px; gap:10px;">
            <button class="btn" type="button" id="btnUploadGaleri">Upload Foto</button>
            <div class="small" id="galeriMsg"></div>
          </div>
        </div>

        <div class="grid grid-3" style="margin-top:12px" id="galeriGrid">
          <div class="card">üì∑ Belum ada foto<br><span class="small">Upload foto pertama untuk anak ini.</span></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="small">¬© <span id="year"></span> iYup Care</div>
    </div>
  </div>

  <!-- MODAL: TAMBAH ANAK -->
  <div class="modal-backdrop" id="modalAnak">
    <div class="modal">
      <h3>Tambah Anak</h3>
      <div class="hr"></div>

      <div id="modalMsg"></div>

      <div class="grid grid-2">
        <div style="grid-column:1 / -1">
          <label>Nama Anak</label>
          <input id="anakNama" type="text" placeholder="Mis: Caca" />
        </div>

        <div>
          <label>Tanggal Lahir</label>
          <input id="anakTglLahir" type="date" />
        </div>

        <div>
          <label>Jenis Kelamin</label>
          <select id="anakJK">
            <option value="">- pilih -</option>
            <option value="Laki-laki">Laki-laki</option>
            <option value="Perempuan">Perempuan</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:flex-end; gap:8px;">
        <button class="btn secondary" type="button" id="btnBatalModal">Batal</button>
        <button class="btn" type="button" id="btnSimpanAnak">
          <span id="btnSimpanAnakText">Simpan</span>
          <span id="btnSimpanAnakSpin" class="spinner" style="display:none;"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- REPORT AREA (untuk PDF) -->
  <div id="reportArea" style="position:absolute; left:-99999px; top:0; width:900px;">
    <div class="card">
      <h2 style="margin:0 0 6px;">Laporan Monitoring</h2>
      <div class="small" id="reportMeta"></div>
      <div class="small" id="reportIdentity" style="margin-top:6px;"></div>
      <div class="hr"></div>

      <div id="reportRiwayat"></div>

      <div style="height:14px"></div>
      <canvas id="reportChartBB" height="180"></canvas>
      <div style="height:14px"></div>
      <canvas id="reportChartTB" height="180"></canvas>

      <div style="height:14px"></div>
      <div class="small" style="margin-bottom:8px;">Galeri</div>
      <div id="reportGaleri" class="grid grid-3"></div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- app -->
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/app.js"></script>

  <script>
    // ===========================
    // CONFIG
    // ===========================
    // Mode produksi (disarankan): PDF pakai image proxy dari backend HF
    // Endpoint yang dibutuhkan: GET /api/galeri/{id}/image  (auth)
    const USE_PROXY_IMAGE_FOR_PDF = true;

    // ===========================
    // Auth + year
    // ===========================
    requireAuthOrRedirect();
    document.getElementById("year").textContent = new Date().getFullYear();

    // ===========================
    // Helpers: api base + token
    // ===========================
    function getApiBase(){
      const meta = document.querySelector('meta[name="api-base"]');
      const base = meta?.getAttribute("content") || "";
      return base.replace(/\/+$/,"");
    }
    function mustToken(){
      const t = (typeof window.getToken === "function") ? window.getToken() : null;
      if(!t) throw new Error("Token login tidak ditemukan. Silakan login ulang.");
      return t;
    }
    async function apiMultipart(path, formData){
      const base = getApiBase();
      const url = `${base}${path.startsWith("/") ? "" : "/"}${path}`;
      const token = mustToken();

      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json",
        },
        body: formData
      });

      let payload = null;
      try { payload = await resp.json(); } catch(e){}

      if(!resp.ok){
        const msg = payload?.message || `Request gagal (${resp.status})`;
        const err = new Error(msg);
        err.status = resp.status;
        err.payload = payload;
        throw err;
      }
      return payload;
    }

    // ===========================
    // Fallback toISODate
    // ===========================
    if(typeof window.toISODate !== "function"){
      window.toISODate = function(d){
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      }
    }

    // ===========================
    // Tabs fallback
    // ===========================
    function setupTabsSafe(rootId){
      if(typeof window.setupTabs === "function"){
        window.setupTabs(rootId);
        const root = document.getElementById(rootId);
        const tabs = root?.querySelectorAll("[data-tab]") || [];
        const panels = root?.querySelectorAll("[data-panel]") || [];
        function syncActive(name){
          panels.forEach(p => p.classList.toggle("active", p.getAttribute("data-panel") === name));
          tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === name));
        }
        const activeTab = Array.from(tabs).find(t => t.classList.contains("active")) || tabs[0];
        if(activeTab) syncActive(activeTab.getAttribute("data-tab"));
        tabs.forEach(t => t.addEventListener("click", () => syncActive(t.getAttribute("data-tab"))));
        return;
      }

      const root = document.getElementById(rootId);
      if(!root) return;
      const tabs = root.querySelectorAll("[data-tab]");
      const panels = root.querySelectorAll("[data-panel]");
      function activate(name){
        tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === name));
        panels.forEach(p => p.classList.toggle("active", p.getAttribute("data-panel") === name));
      }
      tabs.forEach(t => t.addEventListener("click", () => activate(t.getAttribute("data-tab"))));
      if(tabs[0]) activate(tabs[0].getAttribute("data-tab"));
    }
    setupTabsSafe("tabsRoot");

    // ===========================
    // Elements
    // ===========================
    const anakSelect = document.getElementById("anakSelect");
    const riwayatBody = document.getElementById("riwayatBody");
    const dbBody = document.getElementById("dbBody");
    const msg = document.getElementById("msg");
    const chartHint = document.getElementById("chartHint");

    const galeriGrid = document.getElementById("galeriGrid");
    const galeriFile = document.getElementById("galeriFile");
    const galeriCaption = document.getElementById("galeriCaption");
    const btnUploadGaleri = document.getElementById("btnUploadGaleri");
    const galeriMsg = document.getElementById("galeriMsg");

    let chartBB = null;
    let chartTB = null;

    function showMsg(text, kind="ok"){
      msg.innerHTML = `<div class="badge ${kind==="ok" ? "green" : "red"}" style="margin-bottom:10px">${text}</div>`;
    }
    function showModalError(text){
      document.getElementById("modalMsg").innerHTML =
        `<div class="badge red" style="margin-bottom:10px">${text}</div>`;
    }
    function setGaleriMsg(text, kind="ok"){
      galeriMsg.innerHTML = text
        ? `<span class="badge ${kind==="ok" ? "green" : "red"}">${text}</span>`
        : "";
    }

    // ===========================
    // Helpers: escape + age
    // ===========================
    function escHtml(s){
      return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function calcAgeYMD(birthDateStr){
      // "YYYY-MM-DD"
      const b = new Date(birthDateStr + "T00:00:00");
      const now = new Date();

      let y = now.getFullYear() - b.getFullYear();
      let m = now.getMonth() - b.getMonth();
      let d = now.getDate() - b.getDate();

      if(d < 0){
        const prevMonthDays = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
        d += prevMonthDays;
        m -= 1;
      }
      if(m < 0){
        m += 12;
        y -= 1;
      }
      return { y, m, d };
    }

    // ===========================
    // Input toggle
    // ===========================
    const btnToggleInput = document.getElementById("btnToggleInput");
    const formMonitoring = document.getElementById("formMonitoring");
    const inputHint = document.getElementById("inputHint");
    const btnBatalInput = document.getElementById("btnBatalInput");

    function openInput(){
      formMonitoring.classList.remove("hidden");
      inputHint.textContent = "Isi data, lalu klik Simpan Data.";
      document.getElementById("tanggal").value = toISODate(new Date());
      document.getElementById("berat_badan").focus();
    }
    function closeInput(){
      formMonitoring.classList.add("hidden");
      inputHint.textContent = "Klik untuk membuka form input.";
    }
    btnToggleInput.addEventListener("click", () => {
      if(formMonitoring.classList.contains("hidden")) openInput();
      else closeInput();
    });
    btnBatalInput.addEventListener("click", closeInput);

    // ===========================
    // Render DB table
    // ===========================
    function renderDbTable(list){
      if(!list.length){
        dbBody.innerHTML = `<tr><td colspan="8" class="small">Belum ada data monitoring untuk anak ini.</td></tr>`;
        return;
      }
      dbBody.innerHTML = list.slice().reverse().map(x => `
        <tr>
          <td>${x.id ?? "-"}</td>
          <td>${x.anak_id ?? "-"}</td>
          <td>${String(x.tanggal_ukur ?? "").slice(0,10) || "-"}</td>
          <td>${x.berat_badan ?? "-"}</td>
          <td>${x.tinggi_badan ?? "-"}</td>
          <td>${escHtml((x.catatan ?? "").toString().slice(0,40) || "-")}</td>
          <td>${x.created_at ? String(x.created_at).replace("T"," ").slice(0,19) : "-"}</td>
          <td>${x.updated_at ? String(x.updated_at).replace("T"," ").slice(0,19) : "-"}</td>
        </tr>
      `).join("");
    }

    // ===========================
    // Galeri: render + load + upload
    // ===========================
    function renderGaleriGrid(items){
      if(!items || !items.length){
        galeriGrid.innerHTML = `<div class="card">üì∑ Belum ada foto<br><span class="small">Upload foto pertama untuk anak ini.</span></div>`;
        return;
      }

      galeriGrid.innerHTML = items.map(it => {
        const fid = it.drive_file_id || "";
        const thumbUrl = fid
          ? `https://drive.google.com/thumbnail?id=${encodeURIComponent(fid)}&sz=w1000`
          : (it.public_url || "");

        const openUrl = it.public_url || "#";
        const titleRaw = it.caption ? it.caption : (it.original_name || "Foto");
        const title = escHtml(titleRaw);
        const dt = it.created_at ? String(it.created_at).replace("T"," ").slice(0,16) : "";
        const original = it.original_name ? escHtml(String(it.original_name).slice(0,40)) : "";

        return `
          <div class="card galeri-item">
            <a href="${openUrl}" target="_blank" rel="noreferrer">
              <img src="${thumbUrl}" alt="${title}" loading="lazy" />
            </a>
            <div class="galeri-meta">
              <div>
                <div class="galeri-caption">${title}</div>
                <div class="small small-muted">${original}</div>
              </div>
              <div class="galeri-date">${dt}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    async function loadGaleriByAnak(anakId){
      if(!anakId) return [];
      setGaleriMsg("Memuat galeri...", "ok");
      try{
        const res = await api(`/anak/${anakId}/galeri`, { method:"GET", auth:true });
        const items = res?.data || [];
        renderGaleriGrid(items);
        setGaleriMsg("", "ok");
        return items;
      }catch(err){
        console.error(err);
        setGaleriMsg(err?.payload?.message || err.message || "Gagal memuat galeri.", "err");
        renderGaleriGrid([]);
        return [];
      }
    }

    async function uploadGaleriForAnak(anakId){
      const f = galeriFile.files?.[0];
      const cap = (galeriCaption.value || "").trim();

      if(!anakId){ setGaleriMsg("Pilih anak dulu.", "err"); return; }
      if(!f){ setGaleriMsg("Pilih file foto dulu.", "err"); return; }

      const allowed = ["image/jpeg","image/png","image/webp"];
      if(!allowed.includes(f.type)){ setGaleriMsg("Format harus JPG/PNG/WEBP.", "err"); return; }
      const max = 5 * 1024 * 1024;
      if(f.size > max){ setGaleriMsg("Ukuran file maksimal 5MB.", "err"); return; }
      if(cap.length > 200){ setGaleriMsg("Caption maksimal 200 karakter.", "err"); return; }

      const fd = new FormData();
      fd.append("file", f);
      if(cap) fd.append("caption", cap);

      btnUploadGaleri.disabled = true;
      setGaleriMsg("Mengupload...", "ok");

      try{
        await apiMultipart(`/anak/${anakId}/galeri`, fd);

        galeriFile.value = "";
        galeriCaption.value = "";

        setGaleriMsg("Upload sukses. Memuat ulang galeri...", "ok");
        await loadGaleriByAnak(anakId);
        setGaleriMsg("Upload sukses.", "ok");
      }catch(err){
        console.error(err);
        const errors = err?.payload?.errors;
        const detail = errors
          ? Object.entries(errors).map(([k,v]) => `${k}: ${Array.isArray(v)?v.join(", "):v}`).join(" | ")
          : "";
        setGaleriMsg(detail || err?.payload?.message || err.message || "Upload gagal.", "err");
      }finally{
        btnUploadGaleri.disabled = false;
      }
    }

    btnUploadGaleri.addEventListener("click", async () => {
      const anakId = anakSelect.value;
      await uploadGaleriForAnak(anakId);
    });

    // ===========================
    // Render riwayat + grafik
    // ===========================
    async function renderRiwayatAndCharts(anakId){
      riwayatBody.innerHTML = `<tr><td colspan="4" class="small">Memuat...</td></tr>`;
      dbBody.innerHTML = `<tr><td colspan="8" class="small">Memuat...</td></tr>`;
      chartHint.textContent = "";

      const list = await loadMonitoringByAnak(anakId);

      if(!list.length){
        riwayatBody.innerHTML = `<tr><td colspan="4" class="small">Belum ada data monitoring.</td></tr>`;
        renderDbTable([]);
        chartHint.textContent = "Belum ada data untuk digrafikkan.";
        if(chartBB) chartBB.destroy();
        if(chartTB) chartTB.destroy();
        return;
      }

      list.sort((a,b) => String(a.tanggal_ukur).localeCompare(String(b.tanggal_ukur)));

      riwayatBody.innerHTML = list.slice().reverse().map(x => `
        <tr>
          <td>${String(x.tanggal_ukur ?? "").slice(0,10) || "-"}</td>
          <td>${x.berat_badan ?? "-"}</td>
          <td>${x.tinggi_badan ?? "-"}</td>
          <td>${escHtml((x.catatan ?? "").toString().slice(0,60) || "-")}</td>
        </tr>
      `).join("");

      renderDbTable(list);

      const labels = list.map(x => String(x.tanggal_ukur ?? "").slice(0,10) || "‚Äî");
      const weights = list.map(x => Number(x.berat_badan ?? 0));
      const heights = list.map(x => Number(x.tinggi_badan ?? 0));

      if(typeof Chart === "undefined"){
        chartHint.textContent = "Chart.js tidak tersedia.";
        return;
      }

      if(chartBB) chartBB.destroy();
      if(chartTB) chartTB.destroy();

      chartBB = new Chart(document.getElementById("chartBB"), {
        type:"line",
        data:{ labels, datasets:[{ label:"BB (kg)", data:weights, tension:.35 }] },
        options:{ responsive:true, plugins:{ legend:{display:false} } }
      });

      chartTB = new Chart(document.getElementById("chartTB"), {
        type:"line",
        data:{ labels, datasets:[{ label:"TB (cm)", data:heights, tension:.35 }] },
        options:{ responsive:true, plugins:{ legend:{display:false} } }
      });

      chartHint.textContent = "Grafik otomatis mengikuti data input (entry pertama sampai terakhir).";
    }

    // ===========================
    // Init anak dropdown
    // ===========================
    (async () => {
      await loadAnakList("anakSelect");

      anakSelect.addEventListener("change", async () => {
        const id = anakSelect.value;
        if(!id) return;
        await renderRiwayatAndCharts(id);
        await loadGaleriByAnak(id);
      });

      if(anakSelect.options.length > 1){
        anakSelect.selectedIndex = 1;
        const id = anakSelect.value;
        await renderRiwayatAndCharts(id);
        await loadGaleriByAnak(id);
      } else {
        renderGaleriGrid([]);
      }
    })();

    // ===========================
    // Submit monitoring
    // ===========================
    document.getElementById("formMonitoring").addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.innerHTML = "";

      const anakId = anakSelect.value;
      if(!anakId){
        showMsg("Pilih anak dulu sebelum menyimpan.", "err");
        return;
      }

      const payload = {
        tanggal_ukur: document.getElementById("tanggal").value || null,
        berat_badan: Number(document.getElementById("berat_badan").value),
        tinggi_badan: Number(document.getElementById("tinggi_badan").value),
        catatan: document.getElementById("catatan").value?.trim() || null,
      };

      try{
        await api(`/anak/${anakId}/monitoring`, { method:"POST", body:payload, auth:true });
        showMsg("Data berhasil disimpan.", "ok");

        document.getElementById("berat_badan").value = "";
        document.getElementById("tinggi_badan").value = "";
        document.getElementById("catatan").value = "";

        await renderRiwayatAndCharts(anakId);
        closeInput();
      }catch(err){
        const errors = err?.payload?.errors;
        const detail = errors
          ? Object.entries(errors).map(([k,v]) => `${k}: ${Array.isArray(v)?v.join(", "):v}`).join(" | ")
          : "";
        showMsg(detail || err.message || "Gagal menyimpan.", "err");
        console.error(err);
      }
    });

    // ===========================
    // Modal tambah anak + loading
    // ===========================
    const modal = document.getElementById("modalAnak");
    const anakNama = document.getElementById("anakNama");
    const anakTglLahir = document.getElementById("anakTglLahir");
    const anakJK = document.getElementById("anakJK");

    const btnSimpanAnak = document.getElementById("btnSimpanAnak");
    const btnSimpanAnakText = document.getElementById("btnSimpanAnakText");
    const btnSimpanAnakSpin = document.getElementById("btnSimpanAnakSpin");

    function setChildSaveLoading(isLoading){
      btnSimpanAnak.disabled = isLoading;
      document.getElementById("btnBatalModal").disabled = isLoading;
      btnSimpanAnakSpin.style.display = isLoading ? "inline-block" : "none";
      btnSimpanAnakText.textContent = isLoading ? "Menyimpan" : "Simpan";
    }

    function openModal(){
      document.getElementById("modalMsg").innerHTML = "";
      anakNama.value = "";
      anakTglLahir.value = "";
      anakJK.value = "";
      modal.style.display = "flex";
      setChildSaveLoading(false);
      setTimeout(() => anakNama.focus(), 10);
    }
    function closeModal(){ modal.style.display = "none"; }

    document.getElementById("btnTambahAnak").addEventListener("click", openModal);
    document.getElementById("btnBatalModal").addEventListener("click", () => {
      if(btnSimpanAnak.disabled) return;
      closeModal();
    });
    modal.addEventListener("click", (e) => {
      if(e.target === modal && !btnSimpanAnak.disabled) closeModal();
    });

    function normalizeGender(v){
      const s = String(v || "").trim();
      if(s === "Laki-laki" || s === "Perempuan") return s;
      const lower = s.toLowerCase();
      if(["l","lk","laki","laki-laki","male"].includes(lower)) return "Laki-laki";
      if(["p","pr","perempuan","female"].includes(lower)) return "Perempuan";
      return s;
    }

    btnSimpanAnak.addEventListener("click", async () => {
      const nama = anakNama.value.trim();
      const tgl  = anakTglLahir.value;
      const jk   = normalizeGender(anakJK.value);

      if(!nama){ showModalError("Nama anak wajib diisi."); return; }
      if(!tgl){ showModalError("Tanggal lahir wajib diisi."); return; }
      if(!jk){ showModalError("Jenis kelamin wajib dipilih."); return; }

      const body = { nama_anak: nama, tanggal_lahir: tgl, jenis_kelamin: jk };

      try{
        setChildSaveLoading(true);
        const created = await api("/anak", { method:"POST", auth:true, body });

        closeModal();
        showMsg("Anak berhasil ditambahkan.", "ok");

        await loadAnakList("anakSelect");
        const newId = created?.data?.id || created?.id;
        if(newId) anakSelect.value = String(newId);
        else anakSelect.selectedIndex = anakSelect.options.length - 1;

        await renderRiwayatAndCharts(anakSelect.value);
        await loadGaleriByAnak(anakSelect.value);
      }catch(err){
        const errors = err?.payload?.errors;
        const detail = errors
          ? Object.entries(errors).map(([k,v]) => `${k}: ${Array.isArray(v)?v.join(", "):v}`).join(" | ")
          : "";
        showModalError(detail || err.message || "Gagal menambahkan anak.");
        console.error(err);
      }finally{
        setChildSaveLoading(false);
      }
    });

    // ===========================
    // PDF Export (include galeri + identitas)
    // ===========================
    async function loadImage(url){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    async function exportPdfForSelectedAnak(){
      const anakId = anakSelect.value;
      if(!anakId){ showMsg("Pilih anak dulu sebelum unduh PDF.", "err"); return; }

      const anakName = anakSelect.options[anakSelect.selectedIndex]?.textContent || "anak";
      const list = await loadMonitoringByAnak(anakId);
      if(!list.length){ showMsg("Belum ada data monitoring untuk dibuat PDF.", "err"); return; }

      list.sort((a,b) => String(a.tanggal_ukur).localeCompare(String(b.tanggal_ukur)));

      // ---- ambil user + detail anak (untuk identitas)
      let me = null;
      let anakDetail = null;

      try{ me = await api("/me", { method:"GET", auth:true }); } catch(e){}
      try{
        const a = await api(`/anak/${anakId}`, { method:"GET", auth:true });
        anakDetail = a?.data || null;
      }catch(e){}

      const namaIbu = (me?.name || me?.username || me?.email || "-");
      const namaAnak = (anakDetail?.nama_anak || anakName || "-");
      const jkAnak = (anakDetail?.jenis_kelamin || "-");
      const tglLahir = (anakDetail?.tanggal_lahir || null);

      let umurText = "-";
      if(tglLahir){
        const { y, m, d } = calcAgeYMD(tglLahir);
        umurText = `${y} tahun ${m} bulan ${d} hari`;
      }

      // ---- header meta + identitas
      document.getElementById("reportMeta").textContent =
        `${namaAnak} ‚Ä¢ diekspor: ${toISODate(new Date())} ‚Ä¢ total data: ${list.length}`;

      document.getElementById("reportIdentity").innerHTML =
        `Nama Ibu/User: <b>${escHtml(namaIbu)}</b> &nbsp;|&nbsp; ` +
        `Nama Anak: <b>${escHtml(namaAnak)}</b> &nbsp;|&nbsp; ` +
        `JK: <b>${escHtml(jkAnak)}</b> &nbsp;|&nbsp; ` +
        `Umur: <b>${escHtml(umurText)}</b>`;

      // ---- riwayat table
      document.getElementById("reportRiwayat").innerHTML = `
        <table class="table">
          <thead><tr><th>Tanggal</th><th>BB</th><th>TB</th><th>Catatan</th></tr></thead>
          <tbody>
            ${list.slice().reverse().map(x => `
              <tr>
                <td>${String(x.tanggal_ukur ?? "").slice(0,10)}</td>
                <td>${x.berat_badan ?? "-"}</td>
                <td>${x.tinggi_badan ?? "-"}</td>
                <td>${escHtml((x.catatan ?? "").toString().slice(0,80) || "-")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      // ---- galeri list (max 6)
      let galeriList = [];
      try{
        const g = await api(`/anak/${anakId}/galeri`, { method:"GET", auth:true });
        galeriList = g?.data || [];
      }catch(e){
        galeriList = [];
      }
      galeriList = galeriList.slice(0, 6);

      const base = getApiBase();

      if(!galeriList.length){
        document.getElementById("reportGaleri").innerHTML =
          `<div class="card">üì∑ Tidak ada foto galeri</div>`;
      } else {
        // render dulu skeleton html (biar layout fixed)
        document.getElementById("reportGaleri").innerHTML = galeriList.map(it => {
          const title = escHtml((it.caption || it.original_name || "Foto").toString());
          const dt = it.created_at ? String(it.created_at).replace("T"," ").slice(0,16) : "";

          // URL gambar untuk PDF:
          // - produksi: proxy backend (stabil untuk canvas)
          // - fallback: thumbnail drive (sering blank di canvas)
          let imgUrl = "";
          if(USE_PROXY_IMAGE_FOR_PDF){
            imgUrl = `${base}/galeri/${it.id}/image`;
          } else {
            const fid = it.drive_file_id || "";
            imgUrl = fid ? `https://drive.google.com/thumbnail?id=${encodeURIComponent(fid)}&sz=w1200` : (it.public_url || "");
          }

          return `
            <div class="card" style="padding:10px;">
              <img class="report-img" src="${imgUrl}" crossorigin="anonymous" />
              <div style="margin-top:8px;">
                <div style="font-weight:800;font-size:12px;line-height:1.2;">${title}</div>
                <div class="small small-muted">${escHtml(dt)}</div>
              </div>
            </div>
          `;
        }).join("");

        // paksa tunggu gambar benar-benar ter-load sebelum html2canvas
        // (kalau tidak, PDF bisa keburu ‚Äúscreenshot‚Äù sebelum gambar masuk)
        const imgEls = Array.from(document.querySelectorAll("#reportGaleri img"));
        await Promise.all(imgEls.map(img => {
          if(img.complete && img.naturalWidth > 0) return Promise.resolve();
          return new Promise((resolve) => {
            img.onload = () => resolve();
            img.onerror = () => resolve(); // jangan block total; jika gagal, tetap jalan
          });
        }));
      }

      // ---- chart data
      const labels = list.map(x => String(x.tanggal_ukur ?? "").slice(0,10));
      const weights = list.map(x => Number(x.berat_badan ?? 0));
      const heights = list.map(x => Number(x.tinggi_badan ?? 0));

      if(window.__reportChartBB) window.__reportChartBB.destroy();
      if(window.__reportChartTB) window.__reportChartTB.destroy();

      window.__reportChartBB = new Chart(document.getElementById("reportChartBB"), {
        type:"line",
        data:{ labels, datasets:[{ label:"BB (kg)", data:weights, tension:.35 }] },
        options:{ responsive:false, plugins:{ legend:{display:false} } }
      });

      window.__reportChartTB = new Chart(document.getElementById("reportChartTB"), {
        type:"line",
        data:{ labels, datasets:[{ label:"TB (cm)", data:heights, tension:.35 }] },
        options:{ responsive:false, plugins:{ legend:{display:false} } }
      });

      // beri waktu chart render + layout settle
      await new Promise(r => setTimeout(r, 500));

      // ---- html2canvas -> jsPDF
      const canvas = await html2canvas(document.getElementById("reportArea"), {
        scale: 2,
        useCORS: true,
        allowTaint: false,
        backgroundColor: "#ffffff"
      });
      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pageWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let y = 0;
      let heightLeft = imgHeight;

      pdf.addImage(imgData, "PNG", 0, y, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while(heightLeft > 0){
        pdf.addPage();
        y = heightLeft - imgHeight;
        pdf.addImage(imgData, "PNG", 0, y, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      const safeName = String(namaAnak || anakName).replace(/[^\w\-]+/g, "-").toLowerCase();
      pdf.save(`laporan-monitoring-${safeName}.pdf`);
    }

    document.getElementById("btnUnduhPdf").addEventListener("click", async () => {
      try{ await exportPdfForSelectedAnak(); }
      catch(err){ showMsg(err.message || "Gagal membuat PDF.", "err"); console.error(err); }
    });
  </script>
</body>
</html>
