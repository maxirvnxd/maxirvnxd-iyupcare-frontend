<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- API BASE (HF) -->
  <meta name="api-base" content="https://maxirvnxd-iyupcare-backend.hf.space/api" />

  <title>Dashboard â€” iYup Care</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo"></div>
        <div>iYup Care</div>
      </div>

      <div class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="monitoring.html">Monitoring</a>
        <a href="produk.html">Produk</a>
        <a href="kalkulator.html">Kalkulator</a>
        <a href="konsultasi.html">Konsultasi</a>
      </div>

      <div class="row">
        <button class="btn secondary" id="bellBtn" type="button">ğŸ””</button>
        <a href="#" id="logoutLink" class="btn">Logout</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:flex-end">
      <div>
        <h1 id="greeting">Halo, Bunda!</h1>
        <div class="small">Ringkasan kondisi dan akses cepat.</div>
      </div>
      <div class="badge blue" id="notifBadge">Notifikasi: aktif</div>
    </div>

    <div class="grid grid-2" style="margin-top:14px">
      <!-- Profil anak -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="badge green">Profil Anak</div>
            <h2 id="anakNama" style="margin-top:10px">â€”</h2>
            <div class="small">Usia: <span id="anakUsia">â€”</span></div>
          </div>
          <div style="width:70px;height:70px;border-radius:22px;border:1px solid var(--line);display:grid;place-items:center;background:rgba(47,158,68,.08);font-weight:900">
            ğŸ‘¶
          </div>
        </div>

        <hr />
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="small">Status gizi terkini</div>
            <div id="statusLabel" class="badge blue" style="margin-top:8px">Belum ada data</div>
          </div>
          <div>
            <a class="btn secondary" href="monitoring.html">Input Data</a>
          </div>
        </div>

        <div class="small" style="margin-top:10px">
          Catatan: status ini akan semakin akurat kalau monitoring rutin dan kalkulator dipakai.
        </div>
      </div>

      <!-- Mini chart -->
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <div class="badge orange">Grafik Mini</div>
            <h2 style="margin-top:10px">Berat badan 3 data terakhir</h2>
            <div class="small">Preview cepat (bukan laporan lengkap).</div>
          </div>
          <a class="btn secondary" href="monitoring.html">Buka Grafik</a>
        </div>

        <div style="margin-top:12px">
          <canvas id="miniChart" height="120"></canvas>
          <div class="small" id="miniChartHint" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card" style="margin-top:16px">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h2>Menu Utama</h2>
          <div class="small">Akses cepat fitur yang paling sering dipakai.</div>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top:14px">
        <div class="action-tile" onclick="location.href='monitoring.html'">
          <div class="ico">ğŸ“</div>
          <div>
            <div class="t">Input Data (Monitoring)</div>
            <div class="d">Catat BB/TB dan lihat riwayat.</div>
          </div>
        </div>

        <div class="action-tile blue" onclick="location.href='kalkulator.html'">
          <div class="ico">ğŸ§®</div>
          <div>
            <div class="t">Cek Kalori (Kalkulator)</div>
            <div class="d">Kebutuhan kkal/hari berdasarkan aktivitas.</div>
          </div>
        </div>

        <div class="action-tile orange" onclick="location.href='produk.html'">
          <div class="ico">ğŸ¥—</div>
          <div>
            <div class="t">Resep Sehat / Produk</div>
            <div class="d">Edukasi pangan lokal dan ide menu.</div>
          </div>
        </div>

        <div class="action-tile" onclick="location.href='konsultasi.html'">
          <div class="ico">ğŸ’¬</div>
          <div>
            <div class="t">Tanya Ahli</div>
            <div class="d">Chat AI / konsultasi ahli / komunitas.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="small">Â© <span id="year"></span> iYup Care</div>
    </div>
  </div>

  <!-- Chart.js (opsional). Kalau offline, chart akan fallback ke teks. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- IMPORTANT:
       api.js harus diload sebelum auth.js & app.js (karena mereka pakai api(), getToken(), dll) -->
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>

  <script>
    requireAuthOrRedirect();
    document.getElementById("year").textContent = new Date().getFullYear();

    // greeting
    loadMeAndRender("greeting");

    // notif demo
    document.getElementById("bellBtn").addEventListener("click", () => {
      alert("Notifikasi: fitur pengingat akan kamu aktifkan di tahap berikutnya.");
    });

    // logout
    document.getElementById("logoutLink").addEventListener("click", async (e) => {
      e.preventDefault();
      try { await api("/auth/logout", { method:"POST", auth:true }); } catch {}
      clearToken();
      location.href = "login.html";
    });

    // ambil anak pertama (jika ada) dan tampilkan ringkas
    (async () => {
      const anakList = await api("/anak", { auth:true }).catch(() => null);
      const list = Array.isArray(anakList?.data) ? anakList.data : (Array.isArray(anakList) ? anakList : []);
      const anak = list[0];

      if(!anak){
        document.getElementById("anakNama").textContent = "Belum ada data anak";
        document.getElementById("anakUsia").textContent = "â€”";
        document.getElementById("miniChartHint").textContent = "Tambahkan data anak dulu agar grafik bisa tampil.";
        return;
      }

      document.getElementById("anakNama").textContent = anak.nama ?? "Anak";
      document.getElementById("anakUsia").textContent = ageTextFromBirthdate(anak.tanggal_lahir);

      // monitoring 3 data terakhir (kalau endpoint tersedia)
      const mon = await loadMonitoringByAnak(anak.id);
      const last3 = mon.slice(-3);

      if(!last3.length){
        document.getElementById("miniChartHint").textContent = "Belum ada monitoring. Isi dulu di menu Monitoring.";
        return;
      }

      const labels = last3.map(x => (x.tanggal ?? "").toString().slice(0,10) || "â€”");
      const weights = last3.map(x => Number(x.berat_badan ?? x.bb ?? 0));

      // status label sederhana (UI only)
      document.getElementById("statusLabel").className = "badge green";
      document.getElementById("statusLabel").textContent = "Data masuk";

      if(typeof Chart === "undefined"){
        document.getElementById("miniChartHint").textContent = "Chart.js tidak tersedia (offline). Data: " + weights.join(", ");
        return;
      }

      new Chart(document.getElementById("miniChart"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "BB (kg)",
            data: weights,
            tension: 0.35,
            fill: false
          }]
        },
        options: {
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{
            y:{ beginAtZero:false }
          }
        }
      });
    })();
  </script>
</body>
</html>
