<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- API BASE (HF) -->
  <meta name="api-base" content="https://maxirvnxd-iyupcare-backend.hf.space/api" />

  <title>Dashboard ‚Äî iYup Care</title>
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    :root{
      --bg:#f6f9ff;
      --card:#ffffff;
      --ink:#0b1b3a;
      --muted:#5b6b80;
      --line: rgba(15,23,42,.10);
      --shadow: 0 18px 50px rgba(15,23,42,.10);
      --shadow2: 0 12px 30px rgba(15,23,42,.08);
      --primary:#1e63d6;
      --green:#1f9d55;
      --orange:#f2994a;
      --radius:18px;
      --max:1100px;
    }
    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 15% 10%, rgba(30,99,214,.16), transparent 60%),
        radial-gradient(800px 520px at 90% 0%, rgba(31,157,85,.12), transparent 58%),
        radial-gradient(800px 520px at 90% 90%, rgba(242,153,74,.10), transparent 55%),
        var(--bg);
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: var(--max); margin:0 auto; padding: 18px 16px 28px; }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .topbar-inner{
      max-width: var(--max);
      margin: 0 auto;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* BRAND */
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
      flex: 1 1 auto;
    }
    .brand img{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      object-fit: cover;
      background:#fff;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 20px rgba(15,23,42,.12);
      display:block;
      flex: 0 0 auto;
    }
    .brand .b1{ font-weight: 950; letter-spacing:.2px; }
    .brand .b2{ font-size: 12px; color: var(--muted); margin-top:2px; }

    .nav{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:center;
      flex: 2 1 420px;
    }
    .nav a{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.78);
      font-weight: 900;
      font-size: 13px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .nav a:hover{
      border-color: rgba(30,99,214,.25);
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
      transform: translateY(-1px);
    }
    .nav a.active{
      background: linear-gradient(180deg, rgba(30,99,214,1), rgba(20,76,175,1));
      border-color: rgba(30,99,214,.0);
      color:#fff;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1 1 auto;
      margin-left: auto;
    }

    .icon-btn{
      width:42px; height:42px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.78);
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
      font-size: 18px;
      display:grid; place-items:center;
      transition: transform .12s ease, border-color .12s ease;
    }
    .icon-btn:hover{ border-color: rgba(30,99,214,.25); transform: translateY(-1px); }

    .action-link{
      padding: 11px 14px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.78);
      font-weight: 950;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      white-space: nowrap;
    }
    .action-link:hover{ border-color: rgba(30,99,214,.25); transform: translateY(-1px); }

    .logout{
      padding: 11px 14px;
      border-radius: 14px;
      border:1px solid rgba(31,157,85,.25);
      background: rgba(31,157,85,.12);
      font-weight: 950;
      cursor:pointer;
      transition: filter .12s ease, transform .12s ease;
      white-space: nowrap;
    }
    .logout:hover{ filter: brightness(.98); transform: translateY(-1px); }

    /* Page header */
    .page-head{
      padding: 18px 0 8px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .page-head h1{
      margin:0;
      font-size: clamp(24px, 3vw, 34px);
      letter-spacing: -.3px;
    }
    .sub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 950;
      border:1px solid rgba(30,99,214,.18);
      background: rgba(30,99,214,.10);
      font-size: 13px;
      white-space: nowrap;
    }

    /* Cards */
    .grid2{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .card2{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(8px);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card-inner{ padding: 16px; }

    .card-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
    }
    .tag.green{ border-color: rgba(31,157,85,.25); background: rgba(31,157,85,.10); }
    .tag.orange{ border-color: rgba(242,153,74,.25); background: rgba(242,153,74,.10); }

    .title2{
      margin: 10px 0 4px;
      font-size: 18px;
      letter-spacing: -.1px;
    }
    .muted{ color: var(--muted); font-size: 13px; line-height:1.6; }

    .avatar{
      width: 56px; height:56px;
      border-radius: 18px;
      display:grid; place-items:center;
      border:1px solid rgba(15,23,42,.10);
      background: linear-gradient(180deg, rgba(31,157,85,.10), rgba(30,99,214,.10));
      font-size: 26px;
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      flex: 0 0 auto;
    }
    .divider{ height:1px; background: rgba(15,23,42,.08); margin: 14px 0; }

    .row2{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .btn2{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 11px 14px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.78);
      font-weight: 950;
      font-size: 13px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      white-space: nowrap;
    }
    .btn2:hover{ border-color: rgba(30,99,214,.25); transform: translateY(-1px); }

    .status-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      border:1px solid rgba(30,99,214,.22);
      background: rgba(30,99,214,.10);
      color: var(--ink);
    }
    .status-badge.good{
      border-color: rgba(31,157,85,.25);
      background: rgba(31,157,85,.10);
    }

    /* Dropdown */
    .select2{
      padding: 11px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.78);
      font-weight: 900;
      font-size: 13px;
      color: var(--ink);
      outline: none;
      width: 100%;
    }
    .select2:focus{ border-color: rgba(30,99,214,.35); }

    /* Chart frame */
    .chart-wrap{
      margin-top: 12px;
      border:1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      background: rgba(255,255,255,.70);
      padding: 12px;
    }
    #miniChart{ width:100% !important; }

    /* Quick actions */
    .quick{
      margin-top: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(8px);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow2);
    }
    .quick .head{
      padding: 16px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .quick h2{ margin:0; font-size: 18px; letter-spacing:-.1px; }
    .quick .grid{
      padding: 0 16px 16px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    .tile{
      border:1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      background: rgba(255,255,255,.78);
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .tile:hover{
      border-color: rgba(30,99,214,.25);
      box-shadow: 0 12px 26px rgba(15,23,42,.08);
      transform: translateY(-1px);
    }
    .tile .ico{
      width: 44px; height:44px;
      border-radius: 16px;
      display:grid; place-items:center;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(30,99,214,.10);
      font-size: 20px;
      flex: 0 0 auto;
    }
    .tile .t{ font-weight: 950; }
    .tile .d{ margin-top: 3px; color: var(--muted); font-size: 13px; line-height: 1.5; }

    .foot{
      margin-top: 16px;
      padding: 14px 0 4px;
      border-top: 1px solid rgba(15,23,42,.08);
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    /* MOBILE */
    @media (max-width: 980px){
      .nav{ display:none; }
      .grid2{ grid-template-columns: 1fr; }
      .quick .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      .topbar-inner{ padding: 10px 12px; gap: 10px; }
      .brand{ min-width: 0; }
      .brand img{ width: 34px; height: 34px; border-radius: 12px; }
      .brand .b1{ font-size: 14px; }
      .brand .b2{ font-size: 11px; }
      .icon-btn{ width: 40px; height: 40px; border-radius: 13px; }
      .logout, .action-link{ padding: 10px 12px; border-radius: 13px; font-size: 13px; }
      .top-actions{ gap: 8px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="assets/logo-innoviyup.png" alt="Logo InnoviYup" />
        <div>
          <div class="b1">iYup Care</div>
          <div class="b2">Dashboard</div>
        </div>
      </div>

      <nav class="nav" aria-label="Navigasi utama">
        <a class="active" href="dashboard.html">Dashboard</a>
        <a href="monitoring.html">Monitoring</a>
        <a href="produk.html">Produk</a>
        <a href="kalkulator.html">Kalkulator</a>
        <a href="konsultasi.html">Konsultasi</a>
      </nav>

      <div class="top-actions">
        <button class="icon-btn" id="bellBtn" type="button" title="Notifikasi">üîî</button>
        <a class="action-link" href="index.html" title="Kembali ke Beranda">Beranda</a>
        <button class="logout" id="logoutLink" type="button">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="page-head">
      <div>
        <h1 id="greeting">Halo, Bunda!</h1>
        <div class="sub">Ringkasan kondisi dan akses cepat.</div>
      </div>
      <div class="pill" id="notifBadge">Notifikasi: aktif</div>
    </div>

    <section class="grid2" aria-label="Ringkasan">
      <!-- PROFIL ANAK -->
      <article class="card2">
        <div class="card-inner">
          <div class="card-head">
            <div>
              <div class="tag green">Profil Anak</div>
              <h2 id="anakNama" class="title2">‚Äî</h2>
              <div class="muted">Usia: <span id="anakUsia">‚Äî</span></div>
            </div>
            <div class="avatar" aria-hidden="true">üë∂</div>
          </div>

          <div class="divider"></div>

          <div class="row2" style="align-items:flex-start;">
            <div style="min-width:260px; flex:1;">
              <div class="muted">Pilih anak</div>
              <select id="anakPick" class="select2" style="margin-top:8px;">
                <option value="">Memuat...</option>
              </select>

              <div style="margin-top:12px;">
                <div class="muted">Status gizi terkini</div>
                <div id="statusLabel" class="status-badge" style="margin-top:8px">Belum ada data</div>
              </div>
            </div>

            <a class="btn2" id="btnInputData" href="monitoring.html">Input Data</a>
          </div>

          <div class="muted" style="margin-top:10px">
            Catatan: status akan semakin akurat jika monitoring rutin dan kalkulator dipakai.
          </div>
        </div>
      </article>

      <!-- GRAFIK MINI -->
      <article class="card2">
        <div class="card-inner">
          <div class="card-head">
            <div>
              <div class="tag orange">Grafik Mini</div>
              <h2 class="title2">Berat badan 3 data terakhir</h2>
              <div class="muted">Preview cepat (bukan laporan lengkap).</div>
            </div>
            <a class="btn2" href="monitoring.html">Buka Grafik</a>
          </div>

          <div class="chart-wrap">
            <canvas id="miniChart" height="120"></canvas>
            <div class="muted" id="miniChartHint" style="margin-top:8px"></div>
          </div>
        </div>
      </article>
    </section>

    <section class="quick" aria-label="Menu utama">
      <div class="head">
        <div>
          <h2>Menu Utama</h2>
          <div class="muted">Akses cepat fitur yang paling sering dipakai.</div>
        </div>
        <a class="btn2" href="monitoring.html">Mulai Input Monitoring</a>
      </div>

      <div class="grid">
        <div class="tile" onclick="location.href='monitoring.html'">
          <div class="ico">üìù</div>
          <div>
            <div class="t">Input Data (Monitoring)</div>
            <div class="d">Catat BB/TB dan lihat riwayat pertumbuhan.</div>
          </div>
        </div>

        <div class="tile" onclick="location.href='kalkulator.html'">
          <div class="ico">üßÆ</div>
          <div>
            <div class="t">Cek Kalori (Kalkulator)</div>
            <div class="d">Hitung kebutuhan kkal/hari berdasarkan aktivitas.</div>
          </div>
        </div>

        <div class="tile" onclick="location.href='produk.html'">
          <div class="ico">ü•ó</div>
          <div>
            <div class="t">Resep Sehat / Produk</div>
            <div class="d">Edukasi pangan lokal dan info produk gizi InnoviYup.</div>
          </div>
        </div>

        <div class="tile" onclick="location.href='konsultasi.html'">
          <div class="ico">üí¨</div>
          <div>
            <div class="t">Tanya Ahli</div>
            <div class="d">Chat AI &amp; Konsultasi Ahli</div>
          </div>
        </div>

        <div class="tile" onclick="window.open('https://chat.whatsapp.com/Gmc2iHYZanH1FDRe7ogfho','_blank','noopener')">
          <div class="ico">üë•</div>
          <div>
            <div class="t">Komunitas</div>
            <div class="d">Gabung grup WhatsApp komunitas iYup Care.</div>
          </div>
        </div>
      </div>
    </section>

    <div class="foot">
      ¬© <span id="year"></span> iYup Care
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>

  <script>
    requireAuthOrRedirect();
    document.getElementById("year").textContent = new Date().getFullYear();

    loadMeAndRender("greeting");

    document.getElementById("bellBtn").addEventListener("click", () => {
      alert("Notifikasi: fitur pengingat akan kamu aktifkan di tahap berikutnya.");
    });

    document.getElementById("logoutLink").addEventListener("click", async () => {
      try { await api("/auth/logout", { method:"POST", auth:true }); } catch {}
      clearToken();
      location.href = "login.html";
    });

    // =========================
    // Dashboard: pilih anak + grafik mini
    // =========================
    const STORAGE_KEY = "iyup_selected_anak_id";
    const anakPick = document.getElementById("anakPick");
    const btnInputData = document.getElementById("btnInputData");

    let miniChartInstance = null;

    function normalizeArray(resp){
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp?.data)) return resp.data;
      return [];
    }

    function pick(obj, keys){
      for(const k of keys){
        const v = obj?.[k];
        if(v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
      return null;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function getAnakId(a){
      return pick(a, ["id","anak_id","child_id","id_anak"]);
    }

    function getAnakName(a){
      const name = pick(a, ["nama","name","nama_anak","anak_nama","child_name","full_name"]);
      const id = getAnakId(a);
      if(name) return String(name).trim();
      // kalau backend memang tidak kirim nama, minimal beda-beda by ID biar kamu tahu datanya kosong
      return id ? `Anak (ID: ${id})` : "Anak";
    }

    function getBirthdate(a){
      return pick(a, ["tanggal_lahir","tgl_lahir","birthdate","tanggalLahir"]);
    }

    function setStatus(hasData){
      const status = document.getElementById("statusLabel");
      if(hasData){
        status.className = "status-badge good";
        status.textContent = "Data masuk";
      }else{
        status.className = "status-badge";
        status.textContent = "Belum ada data";
      }
    }

    function destroyMiniChart(){
      if(miniChartInstance){
        miniChartInstance.destroy();
        miniChartInstance = null;
      }
    }

    function getMonDate(x){
      // dukung beberapa kemungkinan key tanggal monitoring
      return pick(x, ["tanggal_ukur","tanggal","date","created_at","updated_at"]) ?? "";
    }

    function getMonWeight(x){
      return Number(pick(x, ["berat_badan","bb","berat","weight"]) ?? 0);
    }

    async function renderForAnak(anakRaw){
      if(!anakRaw) return;

      const nama = getAnakName(anakRaw);
      const tgl = getBirthdate(anakRaw);

      document.getElementById("anakNama").textContent = nama;
      document.getElementById("anakUsia").textContent = tgl ? ageTextFromBirthdate(tgl) : "‚Äî";

      const hintEl = document.getElementById("miniChartHint");

      const anakId = getAnakId(anakRaw);
      if(!anakId){
        setStatus(false);
        hintEl.textContent = "Data anak tidak punya ID yang terbaca. Periksa respon API /anak.";
        destroyMiniChart();
        return;
      }

      const monResp = await loadMonitoringByAnak(anakId);
      const mon = normalizeArray(monResp);

      mon.sort((a,b) => String(getMonDate(a)).localeCompare(String(getMonDate(b))));

      if(!mon.length){
        setStatus(false);
        hintEl.textContent = "Belum ada monitoring untuk anak ini. Isi dulu di menu Monitoring.";
        destroyMiniChart();
        return;
      }

      setStatus(true);

      const last3 = mon.slice(-3);
      const labels = last3.map(x => String(getMonDate(x)).slice(0,10) || "‚Äî");
      const weights = last3.map(x => getMonWeight(x));

      if(typeof Chart === "undefined"){
        hintEl.textContent = "Chart.js tidak tersedia. Data BB: " + weights.join(", ");
        destroyMiniChart();
        return;
      }

      hintEl.textContent = "Menampilkan 3 data BB terakhir untuk anak terpilih.";

      destroyMiniChart();
      miniChartInstance = new Chart(document.getElementById("miniChart"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "BB (kg)",
            data: weights,
            tension: 0.35,
            fill: false,
            pointRadius: 3
          }]
        },
        options: {
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:false } }
        }
      });
    }

    async function initAnakPicker(){
      const resp = await api("/anak", { auth:true }).catch(() => null);
      const list = normalizeArray(resp);

      if(!list.length){
        document.getElementById("anakNama").textContent = "Belum ada data anak";
        document.getElementById("anakUsia").textContent = "‚Äî";
        document.getElementById("miniChartHint").textContent = "Tambahkan data anak dulu agar grafik bisa tampil.";
        anakPick.innerHTML = `<option value="">Belum ada anak</option>`;
        setStatus(false);
        destroyMiniChart();
        return;
      }

      // buat options dengan nama yang benar (multi-key)
      anakPick.innerHTML =
        `<option value="">- pilih -</option>` +
        list.map(a => {
          const id = getAnakId(a);
          const nm = getAnakName(a);
          // kalau id null, tetap tampilkan tapi value kosong (biar kelihatan ada problem data)
          return `<option value="${escapeHtml(id ?? "")}">${escapeHtml(nm)}</option>`;
        }).join("");

      // default: localStorage -> kalau tidak valid, pakai anak pertama yang punya ID
      const savedId = localStorage.getItem(STORAGE_KEY);
      const firstWithId = list.find(a => getAnakId(a) !== null) ?? list[0];

      const savedValid = savedId && list.some(a => String(getAnakId(a)) === String(savedId));
      const defaultId = savedValid ? String(savedId) : String(getAnakId(firstWithId) ?? "");

      anakPick.value = defaultId;

      const selected = list.find(a => String(getAnakId(a)) === String(anakPick.value)) ?? firstWithId;
      await renderForAnak(selected);

      anakPick.addEventListener("change", async () => {
        const id = anakPick.value;
        if(!id) return;
        localStorage.setItem(STORAGE_KEY, String(id));
        const chosen = list.find(a => String(getAnakId(a)) === String(id));
        await renderForAnak(chosen);
      });

      btnInputData.addEventListener("click", () => {
        const id = anakPick.value;
        if(id) localStorage.setItem(STORAGE_KEY, String(id));
      });
    }

    initAnakPicker();
  </script>
</body>
</html>
